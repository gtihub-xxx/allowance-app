<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üèÜ „ÅäÂ∞èÈÅ£„ÅÑÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      animation: bounce 2s infinite;
    }

    .header p {
      font-size: 1.2rem;
      opacity: 0.9;
      margin-bottom: 15px;
    }

    .version-info {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      margin-top: 10px;
    }

    .version-badge {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: bold;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .version-btn {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .version-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.05);
    }

    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-10px); }
      60% { transform: translateY(-5px); }
    }

    .children-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 30px;
      margin-bottom: 30px;
    }

    .child-card {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      overflow: hidden;
      position: relative;
      transform: translateY(0);
      transition: all 0.3s ease;
    }

    .child-card:hover {
      transform: translateY(-10px);
      box-shadow: 0 30px 60px rgba(0,0,0,0.2);
    }

    .child-card.child-a {
      border-top: 5px solid #FF6B6B;
    }

    .child-card.child-h {
      border-top: 5px solid #4ECDC4;
    }

    .child-header {
      padding: 25px;
      background: linear-gradient(135deg, #FF6B6B, #FFE66D);
      color: white;
      text-align: center;
      position: relative;
    }

    .child-card.child-h .child-header {
      background: linear-gradient(135deg, #4ECDC4, #44A08D);
    }

    .child-header h2 {
      font-size: 2rem;
      margin-bottom: 10px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }

    .total-amount {
      font-size: 2.5rem;
      font-weight: bold;
      margin-bottom: 5px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .child-content {
      padding: 25px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 25px;
    }

    .stat-card {
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }

    .stat-card:hover {
      transform: scale(1.05);
      border-color: #FF6B6B;
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }

    .child-card.child-h .stat-card:hover {
      border-color: #4ECDC4;
    }

    .stat-icon {
      font-size: 2rem;
      margin-bottom: 10px;
    }

    .stat-label {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 5px;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: #333;
    }

    .record-btn {
      width: 100%;
      background: linear-gradient(135deg, #FF6B6B, #FF8E53);
      color: white;
      border: none;
      padding: 15px 25px;
      border-radius: 50px;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
    }

    .child-card.child-h .record-btn {
      background: linear-gradient(135deg, #4ECDC4, #44A08D);
      box-shadow: 0 5px 15px rgba(78, 205, 196, 0.4);
    }

    .record-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(255, 107, 107, 0.6);
    }

    .child-card.child-h .record-btn:hover {
      box-shadow: 0 8px 25px rgba(78, 205, 196, 0.6);
    }

    .record-btn:active {
      transform: translateY(0);
    }

    .form {
      display: none;
      background: white;
      border-radius: 20px;
      padding: 25px;
      margin-top: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      border: 2px solid #f8f9fa;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-weight: bold;
      color: #333;
      margin-bottom: 8px;
      font-size: 1rem;
    }

    .form-input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      font-size: 1rem;
      transition: all 0.3s ease;
      background: #f8f9fa;
    }

    .form-input:focus {
      outline: none;
      border-color: #FF6B6B;
      background: white;
      box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
    }

    .child-card.child-h .form-input:focus {
      border-color: #4ECDC4;
      box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.1);
    }

    .test-section {
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .test-section-title {
      font-weight: bold;
      color: #333;
      margin-bottom: 15px;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .test-container {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      border: 2px solid #e9ecef;
      transition: all 0.3s ease;
    }

    .test-container:hover {
      border-color: #FF6B6B;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .child-card.child-h .test-container:hover {
      border-color: #4ECDC4;
    }

    .test-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .test-title {
      font-weight: bold;
      color: #333;
      font-size: 1.1rem;
    }

    .remove-test-btn {
      background: linear-gradient(135deg, #FF6B6B, #FF8E53);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .remove-test-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 3px 10px rgba(255, 107, 107, 0.4);
    }

    .test-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .add-test-btn {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 25px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
    }

    .add-test-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
    }

    .checkbox-section {
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      padding: 12px;
      background: white;
      border-radius: 10px;
      transition: all 0.3s ease;
    }

    .checkbox-row:hover {
      transform: translateX(5px);
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    .checkbox-row label {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      font-weight: 500;
      width: 100%;
    }

    .checkbox-row input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: #FF6B6B;
    }

    .submit-section {
      margin-top: 25px;
    }

    .submit-btn {
      width: 100%;
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      border: none;
      padding: 15px 25px;
      border-radius: 50px;
      font-size: 1.2rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
    }

    .submit-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(40, 167, 69, 0.6);
    }

    .actions-section {
      background: white;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    .actions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .action-btn {
      background: linear-gradient(135deg, #6c5ce7, #a29bfe);
      color: white;
      border: none;
      padding: 15px 20px;
      border-radius: 25px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(108, 92, 231, 0.3);
    }

    .action-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(108, 92, 231, 0.5);
    }

    .message {
      background: linear-gradient(135deg, #00b894, #00cec9);
      color: white;
      padding: 15px 20px;
      border-radius: 15px;
      margin: 20px 0;
      font-weight: bold;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0, 184, 148, 0.3);
      display: none;
    }

    .history-section, .last-month-section {
      background: white;
      border-radius: 20px;
      padding: 25px;
      margin-top: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    th {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 15px;
      text-align: center;
      font-weight: bold;
    }

    td {
      padding: 12px;
      text-align: center;
      border-bottom: 1px solid #e9ecef;
    }

    tr:nth-child(even) {
      background: #f8f9fa;
    }

    tr:hover {
      background: linear-gradient(135deg, rgba(255, 107, 107, 0.1), rgba(255, 142, 83, 0.1));
    }

    .spreadsheet-link {
      text-align: center;
      margin-top: 30px;
    }

    .spreadsheet-link a {
      display: inline-block;
      background: linear-gradient(135deg, #fd79a8, #fdcb6e);
      color: white;
      padding: 15px 30px;
      border-radius: 25px;
      text-decoration: none;
      font-weight: bold;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(253, 121, 168, 0.4);
    }

    .spreadsheet-link a:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(253, 121, 168, 0.6);
    }

    @media (max-width: 768px) {
      .children-container {
        grid-template-columns: 1fr;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .test-row {
        grid-template-columns: 1fr;
      }
      
      .actions-grid {
        grid-template-columns: 1fr;
      }
      
      .header h1 {
        font-size: 2rem;
      }
      
      .total-amount {
        font-size: 2rem;
      }
      
      .version-info {
        flex-direction: column;
        gap: 10px;
      }
      
      .version-content {
        margin: 10px;
        padding: 20px;
        max-height: 90vh;
      }
      
      .version-title {
        font-size: 1.5rem;
      }
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* „Éê„Éº„Ç∏„Éß„É≥ÊÉÖÂ†±„É¢„Éº„ÉÄ„É´ */
    .version-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .version-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      margin: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      animation: slideIn 0.3s ease;
    }

    .version-header {
      text-align: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f8f9fa;
    }

    .version-title {
      font-size: 1.8rem;
      color: #333;
      margin-bottom: 10px;
    }

    .version-current {
      display: inline-block;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 8px 20px;
      border-radius: 25px;
      font-weight: bold;
      font-size: 1.1rem;
    }

    .version-section {
      margin-bottom: 20px;
    }

    .version-section h3 {
      color: #333;
      margin-bottom: 10px;
      font-size: 1.2rem;
      border-left: 4px solid #667eea;
      padding-left: 10px;
    }

    .version-section ul {
      list-style: none;
      padding-left: 0;
    }

    .version-section li {
      padding: 5px 0;
      padding-left: 20px;
      position: relative;
    }

    .version-section li:before {
      content: '‚úÖ';
      position: absolute;
      left: 0;
    }

    .version-close {
      position: absolute;
      top: 15px;
      right: 20px;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #666;
      transition: color 0.3s ease;
    }

    .version-close:hover {
      color: #333;
    }

    .version-footer {
      text-align: center;
      margin-top: 25px;
      padding-top: 15px;
      border-top: 2px solid #f8f9fa;
      color: #666;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üèÜ „ÅäÂ∞èÈÅ£„ÅÑÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É† üí∞</h1>
      <p>È†ëÂºµ„Å£„ÅüÂàÜ„Å†„Åë„ÅäÂ∞èÈÅ£„ÅÑ„Åå„ÇÇ„Çâ„Åà„Çã„ÇàÔºÅ</p>
      <div class="version-info">
        <span class="version-badge">v2.1.0</span>
        <button class="version-btn" onclick="showVersionInfo()">‚ÑπÔ∏è „Ç∑„Çπ„ÉÜ„É†ÊÉÖÂ†±</button>
      </div>
    </div>

    <div class="children-container">
      <!-- A „Åï„Çì„ÅÆ„Ç´„Éº„Éâ -->
      <div class="child-card child-a">
        <div class="child-header">
          <h2>üë¶ A „Åï„Çì</h2>
          <div class="total-amount">¬•<span id="totalA">600</span></div>
          <div>‰ªäÊúà„ÅÆ„ÅäÂ∞èÈÅ£„ÅÑ</div>
        </div>
        <div class="child-content">
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-icon">üò¥</div>
              <div class="stat-label">Êó©ÂØù</div>
              <div class="stat-value"><span id="earlyA">0</span> Âõû</div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">üåô</div>
              <div class="stat-label">ÈÅÖÂØù</div>
              <div class="stat-value"><span id="lateA">0</span> Âõû</div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">üíØ</div>
              <div class="stat-label">„ÉÜ„Çπ„Éà100ÁÇπ</div>
              <div class="stat-value"><span id="testA">0</span> Âõû</div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">üè†</div>
              <div class="stat-label">„ÅäÊâã‰ºù„ÅÑ</div>
              <div class="stat-value"><span id="taskA">0</span> Âõû</div>
            </div>
          </div>
          <button class="record-btn" onclick="toggleForm('A')">üìù ‰ªäÊó•„ÅÆË®òÈå≤„Çí„Å§„Åë„Çã</button>
        </div>

        <form class="form" id="formA" onsubmit="submitForm(event, 'A')">
          <div class="form-group">
            <label class="form-label">üìÖ Êó•‰ªò</label>
            <input type="date" name="date" required class="form-input today-date">
          </div>
          
          <div class="form-group">
            <label class="form-label">üõèÔ∏è Â∞±ÂØùÊôÇÈñì</label>
            <input type="time" name="bedtime" class="form-input now-time">
          </div>
          
          <div class="test-section">
            <div class="test-section-title">
              üìö „ÉÜ„Çπ„ÉàË®òÈå≤
            </div>
            <div id="testsContainerA">
              <div class="test-container" data-test-index="0">
                <div class="test-header">
                  <span class="test-title">„ÉÜ„Çπ„Éà 1</span>
                  <button type="button" class="remove-test-btn" onclick="removeTest(this)" style="display: none;">ÂâäÈô§</button>
                </div>
                <div class="test-row">
                  <div class="form-group">
                    <label class="form-label">ÁÇπÊï∞</label>
                    <input type="number" name="test_score" min="0" max="100" class="form-input test-score" placeholder="ÁÇπÊï∞„ÇíÂÖ•Âäõ">
                  </div>
                  <div class="form-group">
                    <label class="form-label">ÁßëÁõÆ</label>
                    <select name="test_subject" class="form-input test-subject" onchange="handleTestSubjectOther(this, 'A', 0)">
                      <option value="">--ÈÅ∏Êäû--</option>
                      <option value="ÂõΩË™û">ÂõΩË™û</option>
                      <option value="ÁÆóÊï∞">ÁÆóÊï∞</option>
                      <option value="ÁêÜÁßë">ÁêÜÁßë</option>
                      <option value="Á§æ‰ºö">Á§æ‰ºö</option>
                      <option value="„Åù„ÅÆ‰ªñ">„Åù„ÅÆ‰ªñ</option>
                    </select>
                    <input type="text" name="test_subject_other" class="form-input test-subject-other" id="testSubjectOtherA0" placeholder="ÁßëÁõÆ„ÇíÂÖ•Âäõ" style="display:none;">
                  </div>
                </div>
              </div>
            </div>
            <button type="button" class="add-test-btn" onclick="addTest('A')">‚ûï „ÉÜ„Çπ„Éà„ÇíËøΩÂä†</button>
          </div>

          <div class="form-group">
            <label class="form-label">üè† „ÅäÊâã‰ºù„ÅÑÂÜÖÂÆπ</label>
            <select name="task" class="form-input" onchange="handleTaskOther(this, 'A')">
              <option value="">--ÈÅ∏Êäû--</option>
              <option value="Èù¥„Å™„Çâ„Åπ">Èù¥„Å™„Çâ„Åπ</option>
              <option value="ÁÆ∏‰∏¶„Åπ">ÁÆ∏‰∏¶„Åπ</option>
              <option value="ÊéÉÈô§">ÊéÉÈô§</option>
              <option value="„Åù„ÅÆ‰ªñ">„Åù„ÅÆ‰ªñ</option>
            </select>
            <input type="text" name="taskOther" id="taskOtherA" class="form-input" placeholder="„ÅäÊâã‰ºù„ÅÑÂÜÖÂÆπ„ÇíÂÖ•Âäõ" style="display:none;">
          </div>
          
          <div class="checkbox-section">
            <div class="checkbox-row">
              <label><input type="checkbox" name="early"> üò¥ Êó©ÂØù„Çí„Åó„Åü (+10ÂÜÜ)</label>
            </div>
            <div class="checkbox-row">
              <label><input type="checkbox" name="late"> üåô ÈÅÖÂØù„Çí„Åó„Åü (-10ÂÜÜ)</label>
            </div>
          </div>

          <div class="submit-section">
            <button type="submit" class="submit-btn">‚ú® Ë®òÈå≤„ÇíÈÄÅ‰ø°</button>
          </div>
        </form>
      </div>

      <!-- H „Åï„Çì„ÅÆ„Ç´„Éº„Éâ -->
      <div class="child-card child-h">
        <div class="child-header">
          <h2>üëß H „Åï„Çì</h2>
          <div class="total-amount">¬•<span id="totalH">300</span></div>
          <div>‰ªäÊúà„ÅÆ„ÅäÂ∞èÈÅ£„ÅÑ</div>
        </div>
        <div class="child-content">
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-icon">üò¥</div>
              <div class="stat-label">Êó©ÂØù</div>
              <div class="stat-value"><span id="earlyH">0</span> Âõû</div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">üåô</div>
              <div class="stat-label">ÈÅÖÂØù</div>
              <div class="stat-value"><span id="lateH">0</span> Âõû</div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">üíØ</div>
              <div class="stat-label">„ÉÜ„Çπ„Éà100ÁÇπ</div>
              <div class="stat-value"><span id="testH">0</span> Âõû</div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">üè†</div>
              <div class="stat-label">„ÅäÊâã‰ºù„ÅÑ</div>
              <div class="stat-value"><span id="taskH">0</span> Âõû</div>
            </div>
          </div>
          <button class="record-btn" onclick="toggleForm('H')">üìù ‰ªäÊó•„ÅÆË®òÈå≤„Çí„Å§„Åë„Çã</button>
        </div>

        <form class="form" id="formH" onsubmit="submitForm(event, 'H')">
          <div class="form-group">
            <label class="form-label">üìÖ Êó•‰ªò</label>
            <input type="date" name="date" required class="form-input today-date">
          </div>
          
          <div class="form-group">
            <label class="form-label">üõèÔ∏è Â∞±ÂØùÊôÇÈñì</label>
            <input type="time" name="bedtime" class="form-input now-time">
          </div>
          
          <div class="test-section">
            <div class="test-section-title">
              üìö „ÉÜ„Çπ„ÉàË®òÈå≤
            </div>
            <div id="testsContainerH">
              <div class="test-container" data-test-index="0">
                <div class="test-header">
                  <span class="test-title">„ÉÜ„Çπ„Éà 1</span>
                  <button type="button" class="remove-test-btn" onclick="removeTest(this)" style="display: none;">ÂâäÈô§</button>
                </div>
                <div class="test-row">
                  <div class="form-group">
                    <label class="form-label">ÁÇπÊï∞</label>
                    <input type="number" name="test_score" min="0" max="100" class="form-input test-score" placeholder="ÁÇπÊï∞„ÇíÂÖ•Âäõ">
                  </div>
                  <div class="form-group">
                    <label class="form-label">ÁßëÁõÆ</label>
                    <select name="test_subject" class="form-input test-subject" onchange="handleTestSubjectOther(this, 'H', 0)">
                      <option value="">--ÈÅ∏Êäû--</option>
                      <option value="ÂõΩË™û">ÂõΩË™û</option>
                      <option value="ÁÆóÊï∞">ÁÆóÊï∞</option>
                      <option value="ÁêÜÁßë">ÁêÜÁßë</option>
                      <option value="Á§æ‰ºö">Á§æ‰ºö</option>
                      <option value="„Åù„ÅÆ‰ªñ">„Åù„ÅÆ‰ªñ</option>
                    </select>
                    <input type="text" name="test_subject_other" class="form-input test-subject-other" id="testSubjectOtherH0" placeholder="ÁßëÁõÆ„ÇíÂÖ•Âäõ" style="display:none;">
                  </div>
                </div>
              </div>
            </div>
            <button type="button" class="add-test-btn" onclick="addTest('H')">‚ûï „ÉÜ„Çπ„Éà„ÇíËøΩÂä†</button>
          </div>

          <div class="form-group">
            <label class="form-label">üè† „ÅäÊâã‰ºù„ÅÑÂÜÖÂÆπ</label>
            <select name="task" class="form-input" onchange="handleTaskOther(this, 'H')">
              <option value="">--ÈÅ∏Êäû--</option>
              <option value="Èù¥„Å™„Çâ„Åπ">Èù¥„Å™„Çâ„Åπ</option>
              <option value="ÁÆ∏‰∏¶„Åπ">ÁÆ∏‰∏¶„Åπ</option>
              <option value="ÊéÉÈô§">ÊéÉÈô§</option>
              <option value="„Åù„ÅÆ‰ªñ">„Åù„ÅÆ‰ªñ</option>
            </select>
            <input type="text" name="taskOther" id="taskOtherH" class="form-input" placeholder="„ÅäÊâã‰ºù„ÅÑÂÜÖÂÆπ„ÇíÂÖ•Âäõ" style="display:none;">
          </div>
          
          <div class="checkbox-section">
            <div class="checkbox-row">
              <label><input type="checkbox" name="early"> üò¥ Êó©ÂØù„Çí„Åó„Åü (+10ÂÜÜ)</label>
            </div>
            <div class="checkbox-row">
              <label><input type="checkbox" name="late"> üåô ÈÅÖÂØù„Çí„Åó„Åü (-10ÂÜÜ)</label>
            </div>
          </div>

          <div class="submit-section">
            <button type="submit" class="submit-btn">‚ú® Ë®òÈå≤„ÇíÈÄÅ‰ø°</button>
          </div>
        </form>
      </div>
    </div>

    <div class="message" id="message"></div>

    <div class="actions-section">
      <div class="actions-grid">
        <button class="action-btn" onclick="toggleHistory()">üìä Â±•Ê≠¥„ÇíË¶ã„Çã</button>
        <button class="action-btn" onclick="showLastMonth()">üìà ÂÖàÊúà„ÅÆÁµêÊûú</button>
      </div>
    </div>

    <div id="history" class="history-section" style="display:none;"></div>
    <div id="lastMonth" class="last-month-section" style="display:none;"></div>

    <!-- „Éê„Éº„Ç∏„Éß„É≥ÊÉÖÂ†±„É¢„Éº„ÉÄ„É´ -->
    <div id="versionModal" class="version-modal">
      <div class="version-content">
        <button class="version-close" onclick="closeVersionInfo()">√ó</button>
        
        <div class="version-header">
          <h2 class="version-title">üèÜ „ÅäÂ∞èÈÅ£„ÅÑÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†</h2>
          <div class="version-current">Version 2.1.0</div>
        </div>

        <div class="version-section">
          <h3>üì± Êñ∞Ê©üËÉΩ v2.1.0</h3>
          <ul>
            <li>Ë§áÊï∞„ÉÜ„Çπ„ÉàÂØæÂøú: 1Êó•„Å´Ë§áÊï∞„ÅÆ„ÉÜ„Çπ„Éà„ÇíË®òÈå≤ÂèØËÉΩ</li>
            <li>ÂãïÁöÑ„ÉÜ„Çπ„ÉàËøΩÂä†: „Äå„ÉÜ„Çπ„Éà„ÇíËøΩÂä†„Äç„Éú„Çø„É≥„ÅßÁÑ°Âà∂ÈôêËøΩÂä†</li>
            <li>„É™„ÉÉ„ÉÅUI: „É¢„ÉÄ„É≥„Å™„Ç´„Éº„Éâ„Éá„Ç∂„Ç§„É≥„ÄÅ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂäπÊûú</li>
            <li>„É¨„Çπ„Éù„É≥„Ç∑„Éñ„Éá„Ç∂„Ç§„É≥: „Çπ„Éû„Éõ„Éª„Çø„Éñ„É¨„ÉÉ„Éà„ÉªPCÂØæÂøú</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>üéØ Âü∫Êú¨Ê©üËÉΩ</h3>
          <ul>
            <li>Â≠ê‰æõÂà•ÁÆ°ÁêÜ: A„Åï„ÇìÔºàÂü∫Êú¨600ÂÜÜÔºâ„ÄÅH„Åï„ÇìÔºàÂü∫Êú¨300ÂÜÜÔºâ</li>
            <li>„Éù„Ç§„É≥„ÉàÂà∂: „ÉÜ„Çπ„Éà100ÁÇπ(+100ÂÜÜ)„ÄÅ„ÅäÊâã‰ºù„ÅÑ(+10ÂÜÜ)</li>
            <li>ÁîüÊ¥ªÁøíÊÖ£: Êó©ÂØù(+10ÂÜÜ)„ÄÅÈÅÖÂØù(-10ÂÜÜ)</li>
            <li>Â±•Ê≠¥ÁÆ°ÁêÜ: Áõ¥Ëøë10Êó•Èñì„ÅÆË®òÈå≤Ë°®Á§∫</li>
            <li>ÊúàÊ¨°ÈõÜË®à: ÂÖàÊúà„ÅÆÁµêÊûúË°®Á§∫</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>üîß „Ç∑„Çπ„ÉÜ„É†ÊßãÊàê</h3>
          <ul>
            <li>„Éï„É≠„É≥„Éà„Ç®„É≥„Éâ: HTML/CSS/JavaScript</li>
            <li>„Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ: Google Apps Script</li>
            <li>„Éá„Éº„Çø„Éô„Éº„Çπ: Google Spreadsheet</li>
            <li>Ë§áÊï∞„ÉÜ„Çπ„Éà: JSONÂΩ¢Âºè„Åß„Éá„Éº„Çø‰øùÂ≠ò</li>
          </ul>
        </div>

        <div class="version-footer">
          <p>ÊúÄÁµÇÊõ¥Êñ∞: 2025Âπ¥6Êúà2Êó•</p>
          <p>üéâ Ë§áÊï∞„ÉÜ„Çπ„ÉàÊ©üËÉΩ„ÅåÂÆåÂÖ®Âãï‰Ωú‰∏≠ÔºÅ</p>
        </div>
      </div>
    </div>

    <div class="spreadsheet-link">
      <a href="https://docs.google.com/spreadsheets/d/1TYzfK0qGEYS-_njaXugkHO8knr1dJTOqPU_4qrDva_s/edit?usp=sharing" target="_blank" rel="noopener noreferrer">
        üìä ÂÖÉ„Éá„Éº„ÇøÔºà„Çπ„Éó„É¨„ÉÉ„Éâ„Ç∑„Éº„ÉàÔºâ„ÇíË¶ã„Çã
      </a>
    </div>
  </div>

  <script>
    const endpoint = "https://script.google.com/macros/s/AKfycbyjBZGHrGGLgTvnS1GYbr_SYd-1F0QISJFMiv5JgeMexQSQDrlHnoQS3-llIPOaE2EY/exec";
    let testCounters = { A: 1, H: 1 };

    function handleTaskOther(select, child) {
      const input = document.getElementById(`taskOther${child}`);
      input.style.display = select.value === "„Åù„ÅÆ‰ªñ" ? "block" : "none";
    }

    function handleTestSubjectOther(select, child, testIndex) {
      const input = document.getElementById(`testSubjectOther${child}${testIndex}`);
      input.style.display = select.value === "„Åù„ÅÆ‰ªñ" ? "block" : "none";
    }

    function addTest(child) {
      const container = document.getElementById(`testsContainer${child}`);
      const testIndex = testCounters[child];
      testCounters[child]++;

      const testDiv = document.createElement('div');
      testDiv.className = 'test-container';
      testDiv.setAttribute('data-test-index', testIndex);
      testDiv.style.opacity = '0';
      testDiv.style.transform = 'translateY(-20px)';
      
      testDiv.innerHTML = `
        <div class="test-header">
          <span class="test-title">„ÉÜ„Çπ„Éà ${testIndex + 1}</span>
          <button type="button" class="remove-test-btn" onclick="removeTest(this)">ÂâäÈô§</button>
        </div>
        <div class="test-row">
          <div class="form-group">
            <label class="form-label">ÁÇπÊï∞</label>
            <input type="number" name="test_score" min="0" max="100" class="form-input test-score" placeholder="ÁÇπÊï∞„ÇíÂÖ•Âäõ">
          </div>
          <div class="form-group">
            <label class="form-label">ÁßëÁõÆ</label>
            <select name="test_subject" class="form-input test-subject" onchange="handleTestSubjectOther(this, '${child}', ${testIndex})">
              <option value="">--ÈÅ∏Êäû--</option>
              <option value="ÂõΩË™û">ÂõΩË™û</option>
              <option value="ÁÆóÊï∞">ÁÆóÊï∞</option>
              <option value="ÁêÜÁßë">ÁêÜÁßë</option>
              <option value="Á§æ‰ºö">Á§æ‰ºö</option>
              <option value="„Åù„ÅÆ‰ªñ">„Åù„ÅÆ‰ªñ</option>
            </select>
            <input type="text" name="test_subject_other" class="form-input test-subject-other" id="testSubjectOther${child}${testIndex}" placeholder="ÁßëÁõÆ„ÇíÂÖ•Âäõ" style="display:none;">
          </div>
        </div>
      `;
      
      container.appendChild(testDiv);
      
      // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂäπÊûú
      setTimeout(() => {
        testDiv.style.transition = 'all 0.3s ease';
        testDiv.style.opacity = '1';
        testDiv.style.transform = 'translateY(0)';
      }, 10);
      
      updateRemoveButtons(child);
    }

    function removeTest(button) {
      const testContainer = button.closest('.test-container');
      const form = testContainer.closest('form');
      const child = form.id.slice(-1);
      
      // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂäπÊûú
      testContainer.style.transition = 'all 0.3s ease';
      testContainer.style.opacity = '0';
      testContainer.style.transform = 'translateX(-100%)';
      
      setTimeout(() => {
        testContainer.remove();
        updateRemoveButtons(child);
        updateTestTitles(child);
      }, 300);
    }

    function updateRemoveButtons(child) {
      const container = document.getElementById(`testsContainer${child}`);
      const testContainers = container.querySelectorAll('.test-container');
      
      testContainers.forEach((container, index) => {
        const removeBtn = container.querySelector('.remove-test-btn');
        removeBtn.style.display = testContainers.length > 1 ? 'block' : 'none';
      });
    }

    function updateTestTitles(child) {
      const container = document.getElementById(`testsContainer${child}`);
      const testContainers = container.querySelectorAll('.test-container');
      
      testContainers.forEach((container, index) => {
        const title = container.querySelector('.test-title');
        title.textContent = `„ÉÜ„Çπ„Éà ${index + 1}`;
      });
    }

    function toggleForm(child) {
      const form = document.getElementById("form" + child);
      if (form.style.display === 'block') {
        form.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
          form.style.display = 'none';
        }, 300);
      } else {
        form.style.display = 'block';
        form.style.animation = 'slideIn 0.3s ease';
      }
    }

    function submitForm(event, child) {
      event.preventDefault();
      const form = event.target;
      const submitBtn = form.querySelector('.submit-btn');
      const originalText = submitBtn.textContent;
      
      // „É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖã
      submitBtn.innerHTML = '<div class="loading"></div> ÈÄÅ‰ø°‰∏≠...';
      submitBtn.disabled = true;
      
      const formData = new FormData();
      formData.append("child", child);
      formData.append("date", form.date.value);
      formData.append("bedtime", form.bedtime.value);
      formData.append("early", form.early.checked);
      formData.append("late", form.late.checked);
      
      const taskVal = form.task.value === "„Åù„ÅÆ‰ªñ" ? form.taskOther.value : form.task.value;
      formData.append("task", taskVal);

      // „ÉÜ„Çπ„ÉàÊÉÖÂ†±„ÇíÂèéÈõÜÔºà„Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞ËøΩÂä†Ôºâ
      const testContainers = form.querySelectorAll('.test-container');
      const tests = [];
      
      console.log(`${child}„Åï„Çì: ${testContainers.length}ÂÄã„ÅÆ„ÉÜ„Çπ„Éà„Ç≥„É≥„ÉÜ„Éä„ÇíÁô∫Ë¶ã`);
      
      testContainers.forEach((container, index) => {
        const scoreInput = container.querySelector('.test-score');
        const subjectSelect = container.querySelector('.test-subject');
        const subjectOtherInput = container.querySelector('.test-subject-other');
        
        const score = scoreInput ? scoreInput.value : '';
        const subject = subjectSelect ? subjectSelect.value : '';
        const subjectOther = subjectOtherInput ? subjectOtherInput.value : '';
        
        console.log(`„ÉÜ„Çπ„Éà${index + 1}: ÁÇπÊï∞=${score}, ÁßëÁõÆ=${subject}, „Åù„ÅÆ‰ªñ=${subjectOther}`);
        
        if (score && score.trim() !== '') { // ÁÇπÊï∞„ÅåÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„ÅøË®òÈå≤
          const finalSubject = subject === "„Åù„ÅÆ‰ªñ" ? subjectOther : subject;
          const testData = {
            score: parseInt(score),
            subject: finalSubject || 'Êú™ÂÖ•Âäõ'
          };
          tests.push(testData);
          console.log(`„ÉÜ„Çπ„ÉàËøΩÂä†:`, testData);
        }
      });

      console.log(`${child}„Åï„Çì: ÊúÄÁµÇÁöÑ„Å™„ÉÜ„Çπ„Éà„Éá„Éº„Çø:`, tests);

      // Ê°à1ÔºöÊó¢Â≠òÂàó‰øùÊåÅÔºã„ÉÜ„Çπ„ÉàË©≥Á¥∞ÂàóËøΩÂä†
      // Êó¢Â≠òÂàóÁî®ÔºàÊúÄÂàù„ÅÆ„ÉÜ„Çπ„ÉàÔºâ
      if (tests.length > 0) {
        formData.append("test", tests[0].score);
        formData.append("subject", tests[0].subject);
        console.log(`Êó¢Â≠òÂàóÁî®„Éá„Éº„Çø: ÁÇπÊï∞=${tests[0].score}, ÁßëÁõÆ=${tests[0].subject}`);
      } else {
        formData.append("test", "");
        formData.append("subject", "");
        console.log('Êó¢Â≠òÂàóÁî®„Éá„Éº„Çø: „ÉÜ„Çπ„Éà„Å™„Åó');
      }
      
      // Êñ∞„Åó„ÅÑ„ÉÜ„Çπ„ÉàË©≥Á¥∞Âàó
      const testsJSON = JSON.stringify(tests);
      formData.append("tests", testsJSON);
      console.log(`„ÉÜ„Çπ„ÉàË©≥Á¥∞JSON:`, testsJSON);

      fetch(endpoint, {
        method: "POST",
        body: formData
      })
      .then(res => res.text())
      .then(msg => {
        console.log('„Çµ„Éº„Éê„Éº„É¨„Çπ„Éù„É≥„Çπ:', msg);
        const messageDiv = document.getElementById("message");
        messageDiv.textContent = "‚úÖ Ë®òÈå≤„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„ÅüÔºö" + msg;
        messageDiv.style.display = "block";
        
        form.reset();
        form.style.display = 'none';
        resetTestContainers(child);
        
        // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏„Çí3ÁßíÂæå„Å´ÈùûË°®Á§∫
        setTimeout(() => {
          messageDiv.style.display = "none";
        }, 3000);
        
        setTimeout(() => updateCounts(), 1000);
      })
      .catch(err => {
        console.error('ÈÄÅ‰ø°„Ç®„É©„Éº:', err);
        alert("‚ùå ÈÄÅ‰ø°„Ç®„É©„ÉºÔºö" + err);
      })
      .finally(() => {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      });
    }

    function resetTestContainers(child) {
      const container = document.getElementById(`testsContainer${child}`);
      const testContainers = container.querySelectorAll('.test-container');
      
      for (let i = testContainers.length - 1; i > 0; i--) {
        testContainers[i].remove();
      }
      
      const firstContainer = container.querySelector('.test-container');
      if (firstContainer) {
        const removeBtn = firstContainer.querySelector('.remove-test-btn');
        removeBtn.style.display = 'none';
        const subjectOtherInput = firstContainer.querySelector('.test-subject-other');
        if (subjectOtherInput) {
          subjectOtherInput.style.display = 'none';
        }
      }
      
      testCounters[child] = 1;
    }

    async function updateCounts() {
      const names = ["A", "H"];
      const now = new Date();
      const thisMonth = now.getMonth();
      const thisYear = now.getFullYear();

      for (const name of names) {
        const url = `${endpoint}?history=true&child=${name}`;
        try {
          const res = await fetch(url);
          const data = await res.json();

          const filtered = data.filter(row => {
            const d = new Date(row["Êó•‰ªò"]);
            return d.getFullYear() === thisYear && d.getMonth() === thisMonth;
          });

          const early = filtered.filter(row => row["Êó©ÂØù"] === 1 || row["Êó©ÂØù"] === "1").length;
          const late = filtered.filter(row => row["ÈÅÖÂØù"] === 1 || row["ÈÅÖÂØù"] === "1").length;
          
          let test100Count = 0;
          filtered.forEach(row => {
            // Ê°à1Ôºö„ÉÜ„Çπ„ÉàË©≥Á¥∞Âàó„ÇíÂÑ™ÂÖà„ÄÅ„Å™„Åë„Çå„Å∞Êó¢Â≠òÂàó„ÇÇÁ¢∫Ë™ç
            if (row["„ÉÜ„Çπ„ÉàË©≥Á¥∞"]) {
              try {
                const tests = JSON.parse(row["„ÉÜ„Çπ„ÉàË©≥Á¥∞"]);
                if (Array.isArray(tests)) {
                  test100Count += tests.filter(test => test.score === 100).length;
                }
              } catch (e) {}
            } else if (Number(row["„ÉÜ„Çπ„ÉàÁÇπÊï∞"]) === 100) {
              // Êó¢Â≠ò„Éá„Éº„Çø„ÅÆÂæåÊñπ‰∫íÊèõÊÄß
              test100Count++;
            }
          });
          
          const task = filtered.filter(row => row["„ÅäÊâã‰ºù„ÅÑÂÜÖÂÆπ"] && row["„ÅäÊâã‰ºù„ÅÑÂÜÖÂÆπ"].toString().trim() !== "").length;

          const total = filtered.reduce((sum, row) => {
            let delta = 0;
            
            // Ê°à1Ôºö„ÉÜ„Çπ„ÉàË©≥Á¥∞Âàó„ÇíÂÑ™ÂÖà„ÄÅ„Å™„Åë„Çå„Å∞Êó¢Â≠òÂàó„ÇÇÁ¢∫Ë™ç
            if (row["„ÉÜ„Çπ„ÉàË©≥Á¥∞"]) {
              try {
                const tests = JSON.parse(row["„ÉÜ„Çπ„ÉàË©≥Á¥∞"]);
                if (Array.isArray(tests)) {
                  delta += tests.filter(test => test.score === 100).length * 100;
                }
              } catch (e) {}
            } else if (Number(row["„ÉÜ„Çπ„ÉàÁÇπÊï∞"]) === 100) {
              // Êó¢Â≠ò„Éá„Éº„Çø„ÅÆÂæåÊñπ‰∫íÊèõÊÄß
              delta += 100;
            }
            
            if (row["„ÅäÊâã‰ºù„ÅÑÂÜÖÂÆπ"] && row["„ÅäÊâã‰ºù„ÅÑÂÜÖÂÆπ"].toString().trim() !== "") delta += 10;
            if (row["Êó©ÂØù"] === 1 || row["Êó©ÂØù"] === "1") delta += 10;
            if (row["ÈÅÖÂØù"] === 1 || row["ÈÅÖÂØù"] === "1") delta -= 10;
            return sum + delta;
          }, name === "A" ? 600 : 300);

          // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂäπÊûú‰ªò„Åç„ÅßÊï∞ÂÄ§Êõ¥Êñ∞
          animateValue(`early${name}`, parseInt(document.getElementById(`early${name}`).textContent), early);
          animateValue(`late${name}`, parseInt(document.getElementById(`late${name}`).textContent), late);
          animateValue(`test${name}`, parseInt(document.getElementById(`test${name}`).textContent), test100Count);
          animateValue(`task${name}`, parseInt(document.getElementById(`task${name}`).textContent), task);
          animateValue(`total${name}`, parseInt(document.getElementById(`total${name}`).textContent), total);

        } catch (err) {
          console.error(`„Ç´„Ç¶„É≥„ÉàÊõ¥Êñ∞Â§±Êïó(${name})`, err);
        }
      }
    }

    function animateValue(elementId, start, end) {
      const element = document.getElementById(elementId);
      const duration = 1000;
      const startTime = performance.now();

      function update(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const current = Math.round(start + (end - start) * progress);
        
        element.textContent = current;
        
        if (progress < 1) {
          requestAnimationFrame(update);
        }
      }
      
      requestAnimationFrame(update);
    }

    window.addEventListener("DOMContentLoaded", () => {
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, '0');
      const dd = String(now.getDate()).padStart(2, '0');
      const dateStr = `${yyyy}-${mm}-${dd}`;
      const hh = String(now.getHours()).padStart(2, '0');
      const mi = String(now.getMinutes()).padStart(2, '0');
      const timeStr = `${hh}:${mi}`;

      document.querySelectorAll(".today-date").forEach(el => el.value = dateStr);
      document.querySelectorAll(".now-time").forEach(el => el.value = timeStr);

      updateCounts();
    });

    async function toggleHistory() {
      const historyDiv = document.getElementById("history");
      historyDiv.style.display = historyDiv.style.display === "none" ? "block" : "none";
      if (historyDiv.innerHTML) return;

      historyDiv.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading"></div> „Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>';

      const names = ["A", "H"];
      let content = '';
      
      for (const name of names) {
        const url = `${endpoint}?history=true&child=${name}`;
        try {
          const res = await fetch(url);
          const data = await res.json();

          const recent = data
            .map(row => ({ ...row, parsed: new Date(row["Êó•‰ªò"]) }))
            .sort((a, b) => a.parsed - b.parsed)
            .slice(-10);

          content += `
            <table>
              <thead>
                <tr>
                  <th colspan="8">üìä ${name} „Åï„Çì„ÅÆÁõ¥Ëøë10Êó•Èñì„ÅÆÂ±•Ê≠¥</th>
                </tr>
                <tr>
                  <th>üìÖ Êó•‰ªò</th><th>üõèÔ∏è Â∞±ÂØù</th><th>üìö „ÉÜ„Çπ„ÉàË©≥Á¥∞</th><th>üè† Êâã‰ºù„ÅÑ</th><th>üò¥ Êó©ÂØù</th><th>üåô ÈÅÖÂØù</th><th>üí∞ Â¢óÊ∏õ</th><th>üíµ Á¥ØÁ©ç</th>
                </tr>
              </thead>
              <tbody>
          `;

          for (const row of recent) {
            const d = row.parsed;
            const weekday = "Êó•ÊúàÁÅ´Ê∞¥Êú®ÈáëÂúü"[d.getDay()];
            const dateStr = `${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getDate().toString().padStart(2, '0')}(${weekday})`;

            let bedtime = "";
            const raw = row["Â∞±ÂØùÊôÇÈñì"];
            if (typeof raw === "string" && raw.includes("T")) {
              const t = new Date(raw);
              if (!isNaN(t)) bedtime = `${String(t.getHours()).padStart(2, '0')}:${String(t.getMinutes()).padStart(2, '0')}`;
            } else if (typeof raw === "string" && raw.includes(":")) {
              const [h, m] = raw.split(":");
              bedtime = `${h.padStart(2, '0')}:${m.padStart(2, '0')}`;
            }

            let testDetails = "";
            // Ê°à1Ôºö„ÉÜ„Çπ„ÉàË©≥Á¥∞Âàó„ÇíÂÑ™ÂÖà„ÄÅ„Å™„Åë„Çå„Å∞Êó¢Â≠òÂàó„ÇÇÁ¢∫Ë™ç
            if (row["„ÉÜ„Çπ„ÉàË©≥Á¥∞"]) {
              try {
                const tests = JSON.parse(row["„ÉÜ„Çπ„ÉàË©≥Á¥∞"]);
                if (Array.isArray(tests)) {
                  testDetails = tests.map(test => `${test.subject || '?'}:${test.score}ÁÇπ`).join('<br>');
                }
              } catch (e) {
                testDetails = row["„ÉÜ„Çπ„ÉàË©≥Á¥∞"];
              }
            } else if (row["ÁßëÁõÆ"] || row["„ÉÜ„Çπ„ÉàÁÇπÊï∞"]) {
              // Êó¢Â≠ò„Éá„Éº„Çø„ÅÆÂæåÊñπ‰∫íÊèõÊÄß
              testDetails = `${row["ÁßëÁõÆ"] || '?'}:${row["„ÉÜ„Çπ„ÉàÁÇπÊï∞"] || '?'}ÁÇπ`;
            }

            content += `
              <tr>
                <td>${dateStr}</td>
                <td>${bedtime}</td>
                <td>${testDetails}</td>
                <td>${row["„ÅäÊâã‰ºù„ÅÑÂÜÖÂÆπ"] || ""}</td>
                <td>${row["Êó©ÂØù"] == "1" ? "‚úÖ" : ""}</td>
                <td>${row["ÈÅÖÂØù"] == "1" ? "‚ùå" : ""}</td>
                <td>${row["Â¢óÊ∏õ"] || ""}</td>
                <td>${row["Á¥ØÁ©çÈáëÈ°ç"] || ""}</td>
              </tr>
            `;
          }
          
          content += '</tbody></table>';
        } catch (err) {
          content += `<p>‚ùå ${name} „Åï„Çì„ÅÆÂ±•Ê≠¥ÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ</p>`;
        }
      }
      
      historyDiv.innerHTML = content;
    }

    async function showLastMonth() {
      const lastMonthDiv = document.getElementById("lastMonth");
      lastMonthDiv.style.display = lastMonthDiv.style.display === "none" ? "block" : "none";
      if (lastMonthDiv.innerHTML) return;

      lastMonthDiv.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading"></div> „Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>';

      const names = ["A", "H"];
      const now = new Date();
      let year = now.getFullYear();
      let month = now.getMonth() - 1;
      if (month < 0) {
        month = 11;
        year--;
      }

      let html = '<h3 style="text-align: center; margin-bottom: 20px; color: #333;">üìà ÂÖàÊúà„ÅÆÁµêÊûú</h3>';
      
      for (const name of names) {
        const url = `${endpoint}?history=true&child=${name}`;
        try {
          const res = await fetch(url);
          const data = await res.json();

          const filtered = data.filter(row => {
            const d = new Date(row["Êó•‰ªò"]);
            return d.getFullYear() === year && d.getMonth() === month;
          });

          const early = filtered.filter(row => row["Êó©ÂØù"] === 1 || row["Êó©ÂØù"] === "1").length;
          const late = filtered.filter(row => row["ÈÅÖÂØù"] === 1 || row["ÈÅÖÂØù"] === "1").length;
          
          let test100Count = 0;
          const testSubjects = {};
          
          filtered.forEach(row => {
            // Ê°à1Ôºö„ÉÜ„Çπ„ÉàË©≥Á¥∞Âàó„ÇíÂÑ™ÂÖà„ÄÅ„Å™„Åë„Çå„Å∞Êó¢Â≠òÂàó„ÇÇÁ¢∫Ë™ç
            if (row["„ÉÜ„Çπ„ÉàË©≥Á¥∞"]) {
              try {
                const tests = JSON.parse(row["„ÉÜ„Çπ„ÉàË©≥Á¥∞"]);
                if (Array.isArray(tests)) {
                  tests.forEach(test => {
                    if (test.score === 100) {
                      test100Count++;
                      const subj = test.subject || "ÔºàÊú™ÂÖ•ÂäõÔºâ";
                      testSubjects[subj] = (testSubjects[subj] || 0) + 1;
                    }
                  });
                }
              } catch (e) {}
            } else if (Number(row["„ÉÜ„Çπ„ÉàÁÇπÊï∞"]) === 100) {
              // Êó¢Â≠ò„Éá„Éº„Çø„ÅÆÂæåÊñπ‰∫íÊèõÊÄß
              test100Count++;
              const subj = row["ÁßëÁõÆ"] || "ÔºàÊú™ÂÖ•ÂäõÔºâ";
              testSubjects[subj] = (testSubjects[subj] || 0) + 1;
            }
          });

          const taskRows = filtered.filter(row => row["„ÅäÊâã‰ºù„ÅÑÂÜÖÂÆπ"] && row["„ÅäÊâã‰ºù„ÅÑÂÜÖÂÆπ"].toString().trim() !== "");
          const task = taskRows.length;
          const taskDetails = {};
          taskRows.forEach(row => {
            const taskName = row["„ÅäÊâã‰ºù„ÅÑÂÜÖÂÆπ"] || "ÔºàÊú™ÂÖ•ÂäõÔºâ";
            taskDetails[taskName] = (taskDetails[taskName] || 0) + 1;
          });

          const total = filtered.reduce((sum, row) => {
            let delta = 0;
            // Ê°à1Ôºö„ÉÜ„Çπ„ÉàË©≥Á¥∞Âàó„ÇíÂÑ™ÂÖà„ÄÅ„Å™„Åë„Çå„Å∞Êó¢Â≠òÂàó„ÇÇÁ¢∫Ë™ç
            if (row["„ÉÜ„Çπ„ÉàË©≥Á¥∞"]) {
              try {
                const tests = JSON.parse(row["„ÉÜ„Çπ„ÉàË©≥Á¥∞"]);
                if (Array.isArray(tests)) {
                  delta += tests.filter(test => test.score === 100).length * 100;
                }
              } catch (e) {}
            } else if (Number(row["„ÉÜ„Çπ„ÉàÁÇπÊï∞"]) === 100) {
              // Êó¢Â≠ò„Éá„Éº„Çø„ÅÆÂæåÊñπ‰∫íÊèõÊÄß
              delta += 100;
            }
            if (row["„ÅäÊâã‰ºù„ÅÑÂÜÖÂÆπ"] && row["„ÅäÊâã‰ºù„ÅÑÂÜÖÂÆπ"].toString().trim() !== "") delta += 10;
            if (row["Êó©ÂØù"] === 1 || row["Êó©ÂØù"] === "1") delta += 10;
            if (row["ÈÅÖÂØù"] === 1 || row["ÈÅÖÂØù"] === "1") delta -= 10;
            return sum + delta;
          }, name === "A" ? 600 : 300);

          let testDetailHtml = "";
          if (test100Count > 0) {
            testDetailHtml = "<ul style='margin:5px 0;padding-left:1.2em; text-align: left;'>";
            for (const subj in testSubjects) {
              testDetailHtml += `<li>${subj}: ${testSubjects[subj]} Âõû</li>`;
            }
            testDetailHtml += "</ul>";
          }

          let taskDetailHtml = "";
          if (task > 0) {
            taskDetailHtml = "<ul style='margin:5px 0;padding-left:1.2em; text-align: left;'>";
            for (const t in taskDetails) {
              taskDetailHtml += `<li>${t}: ${taskDetails[t]} Âõû</li>`;
            }
            taskDetailHtml += "</ul>";
          }

          html += `
            <table style="margin-bottom: 20px;">
              <thead>
                <tr><th colspan="2">üèÜ ${name} „Åï„Çì„ÅÆÂÖàÊúà„ÅÆÁµêÊûú</th></tr>
              </thead>
              <tbody>
                <tr><td>üí∞ „ÅäÂ∞èÈÅ£„ÅÑ</td><td><strong>¬•${total}</strong></td></tr>
                <tr><td>üò¥ Êó©ÂØù</td><td>${early} Âõû</td></tr>
                <tr><td>üåô ÈÅÖÂØù</td><td>${late} Âõû</td></tr>
                <tr><td>üíØ „ÉÜ„Çπ„ÉàÔºà100ÁÇπÔºâ</td><td>${test100Count} Âõû${testDetailHtml}</td></tr>
                <tr><td>üè† „ÅäÊâã‰ºù„ÅÑÂÜÖÂÆπ</td><td>${task} Âõû${taskDetailHtml}</td></tr>
              </tbody>
            </table>
          `;
        } catch (err) {
          html += `<p>‚ùå ${name} „Åï„Çì„ÅÆÂÖàÊúà„Éá„Éº„ÇøÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ</p>`;
        }
      }
      lastMonthDiv.innerHTML = html;
    }

    // „Éê„Éº„Ç∏„Éß„É≥ÊÉÖÂ†±„ÅÆË°®Á§∫/ÈùûË°®Á§∫
    function showVersionInfo() {
      const modal = document.getElementById("versionModal");
      modal.style.display = "flex";
      
      // ESC„Ç≠„Éº„Åß„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closeVersionInfo();
        }
      });
      
      // „É¢„Éº„ÉÄ„É´ËÉåÊôØ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          closeVersionInfo();
        }
      });
    }

    function closeVersionInfo() {
      const modal = document.getElementById("versionModal");
      modal.style.display = "none";
    }
  </script>
</body>
</html>

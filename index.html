<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ† ãŠå°é£ã„ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      animation: bounce 2s infinite;
    }

    .header p {
      font-size: 1.2rem;
      opacity: 0.9;
      margin-bottom: 15px;
    }

    .version-info {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      margin-top: 10px;
    }

    .version-badge {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: bold;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .version-btn {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .version-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.05);
    }

    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-10px); }
      60% { transform: translateY(-5px); }
    }

    .children-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 30px;
      margin-bottom: 30px;
    }

    .child-card {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      overflow: hidden;
      position: relative;
      transform: translateY(0);
      transition: all 0.3s ease;
    }

    .child-card:hover {
      transform: translateY(-10px);
      box-shadow: 0 30px 60px rgba(0,0,0,0.2);
    }

    .child-card.child-a {
      border-top: 5px solid #FF6B6B;
    }

    .child-card.child-h {
      border-top: 5px solid #4ECDC4;
    }

    .child-header {
      padding: 25px;
      background: linear-gradient(135deg, #FF6B6B, #FFE66D);
      color: white;
      text-align: center;
      position: relative;
    }

    .child-card.child-h .child-header {
      background: linear-gradient(135deg, #4ECDC4, #44A08D);
    }

    .child-header h2 {
      font-size: 2rem;
      margin-bottom: 10px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }

    .total-amount {
      font-size: 2.5rem;
      font-weight: bold;
      margin-bottom: 5px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .child-content {
      padding: 25px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 25px;
    }

    .stat-card {
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }

    .stat-card:hover {
      transform: scale(1.05);
      border-color: #FF6B6B;
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }

    .child-card.child-h .stat-card:hover {
      border-color: #4ECDC4;
    }

    .stat-icon {
      font-size: 2rem;
      margin-bottom: 10px;
    }

    .stat-label {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 5px;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: #333;
    }

    .record-btn {
      width: 100%;
      background: linear-gradient(135deg, #FF6B6B, #FF8E53);
      color: white;
      border: none;
      padding: 15px 25px;
      border-radius: 50px;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
    }

    .child-card.child-h .record-btn {
      background: linear-gradient(135deg, #4ECDC4, #44A08D);
      box-shadow: 0 5px 15px rgba(78, 205, 196, 0.4);
    }

    .record-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(255, 107, 107, 0.6);
    }

    .child-card.child-h .record-btn:hover {
      box-shadow: 0 8px 25px rgba(78, 205, 196, 0.6);
    }

    .record-btn:active {
      transform: translateY(0);
    }

    .form {
      display: none;
      background: white;
      border-radius: 20px;
      padding: 25px;
      margin-top: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      border: 2px solid #f8f9fa;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-weight: bold;
      color: #333;
      margin-bottom: 8px;
      font-size: 1rem;
    }

    .form-input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      font-size: 1rem;
      transition: all 0.3s ease;
      background: #f8f9fa;
    }

    .form-input:focus {
      outline: none;
      border-color: #FF6B6B;
      background: white;
      box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
    }

    .child-card.child-h .form-input:focus {
      border-color: #4ECDC4;
      box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.1);
    }

    .test-section {
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .test-section-title {
      font-weight: bold;
      color: #333;
      margin-bottom: 15px;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .test-container {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      border: 2px solid #e9ecef;
      transition: all 0.3s ease;
    }

    .test-container:hover {
      border-color: #FF6B6B;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .child-card.child-h .test-container:hover {
      border-color: #4ECDC4;
    }

    .test-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .test-title {
      font-weight: bold;
      color: #333;
      font-size: 1.1rem;
    }

    .remove-test-btn {
      background: linear-gradient(135deg, #FF6B6B, #FF8E53);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .remove-test-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 3px 10px rgba(255, 107, 107, 0.4);
    }

    .test-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .add-test-btn {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 25px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
    }

    .add-test-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
    }

    .checkbox-section {
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      padding: 12px;
      background: white;
      border-radius: 10px;
      transition: all 0.3s ease;
    }

    .checkbox-row:hover {
      transform: translateX(5px);
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    .checkbox-row label {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      font-weight: 500;
      width: 100%;
    }

    .checkbox-row input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: #FF6B6B;
    }

    .submit-section {
      margin-top: 25px;
    }

    .submit-btn {
      width: 100%;
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      border: none;
      padding: 15px 25px;
      border-radius: 50px;
      font-size: 1.2rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
    }

    .submit-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(40, 167, 69, 0.6);
    }

    .actions-section {
      background: white;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    .actions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .action-btn {
      background: linear-gradient(135deg, #6c5ce7, #a29bfe);
      color: white;
      border: none;
      padding: 15px 20px;
      border-radius: 25px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(108, 92, 231, 0.3);
    }

    .action-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(108, 92, 231, 0.5);
    }

    .message {
      background: linear-gradient(135deg, #00b894, #00cec9);
      color: white;
      padding: 15px 20px;
      border-radius: 15px;
      margin: 20px 0;
      font-weight: bold;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0, 184, 148, 0.3);
      display: none;
    }

    .history-section, .last-month-section {
      background: white;
      border-radius: 20px;
      padding: 25px;
      margin-top: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    th {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 15px;
      text-align: center;
      font-weight: bold;
    }

    td {
      padding: 12px;
      text-align: center;
      border-bottom: 1px solid #e9ecef;
    }

    tr:nth-child(even) {
      background: #f8f9fa;
    }

    tr:hover {
      background: linear-gradient(135deg, rgba(255, 107, 107, 0.1), rgba(255, 142, 83, 0.1));
    }

    .spreadsheet-link {
      text-align: center;
      margin-top: 30px;
    }

    .spreadsheet-link a {
      display: inline-block;
      background: linear-gradient(135deg, #fd79a8, #fdcb6e);
      color: white;
      padding: 15px 30px;
      border-radius: 25px;
      text-decoration: none;
      font-weight: bold;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(253, 121, 168, 0.4);
    }

    .spreadsheet-link a:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(253, 121, 168, 0.6);
    }

    @media (max-width: 768px) {
      .children-container {
        grid-template-columns: 1fr;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .test-row {
        grid-template-columns: 1fr;
      }
      
      .actions-grid {
        grid-template-columns: 1fr;
      }
      
      .header h1 {
        font-size: 2rem;
      }
      
      .total-amount {
        font-size: 2rem;
      }
      
      .version-info {
        flex-direction: column;
        gap: 10px;
      }
      
      .version-content {
        margin: 10px;
        padding: 20px;
        max-height: 90vh;
      }
      
      .version-title {
        font-size: 1.5rem;
      }
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .version-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .version-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      margin: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      animation: slideIn 0.3s ease;
    }

    .version-header {
      text-align: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f8f9fa;
    }

    .version-title {
      font-size: 1.8rem;
      color: #333;
      margin-bottom: 10px;
    }

    .version-current {
      display: inline-block;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 8px 20px;
      border-radius: 25px;
      font-weight: bold;
      font-size: 1.1rem;
    }

    .version-section {
      margin-bottom: 20px;
    }

    .version-section h3 {
      color: #333;
      margin-bottom: 10px;
      font-size: 1.2rem;
      border-left: 4px solid #667eea;
      padding-left: 10px;
    }

    .version-section ul {
      list-style: none;
      padding-left: 0;
    }

    .version-section li {
      padding: 5px 0;
      padding-left: 20px;
      position: relative;
    }

    .version-section li:before {
      content: 'âœ…';
      position: absolute;
      left: 0;
    }

    .version-close {
      position: absolute;
      top: 15px;
      right: 20px;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #666;
      transition: color 0.3s ease;
    }

    .version-close:hover {
      color: #333;
    }

    .version-footer {
      text-align: center;
      margin-top: 25px;
      padding-top: 15px;
      border-top: 2px solid #f8f9fa;
      color: #666;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ† ãŠå°é£ã„ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  ğŸ’°</h1>
      <p>é ‘å¼µã£ãŸåˆ†ã ã‘ãŠå°é£ã„ãŒã‚‚ã‚‰ãˆã‚‹ã‚ˆï¼</p>
      <div class="version-info">
        <span class="version-badge">v2.1.0</span>
        <button class="version-btn" onclick="showVersionInfo()">â„¹ï¸ ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±</button>
      </div>
    </div>

    <div class="children-container">
      <!-- A ã•ã‚“ã®ã‚«ãƒ¼ãƒ‰ -->
      <div class="child-card child-a">
        <div class="child-header">
          <h2>ğŸ‘¦ A ã•ã‚“</h2>
          <div class="total-amount">Â¥<span id="totalA">600</span></div>
          <div>ä»Šæœˆã®ãŠå°é£ã„</div>
        </div>
        <div class="child-content">
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-icon">ğŸ˜´</div>
              <div class="stat-label">æ—©å¯</div>
              <div class="stat-value"><span id="earlyA">0</span> å›</div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">ğŸŒ™</div>
              <div class="stat-label">é…å¯</div>
              <div class="stat-value"><span id="lateA">0</span> å›</div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">ğŸ’¯</div>
              <div class="stat-label">ãƒ†ã‚¹ãƒˆ100ç‚¹</div>
              <div class="stat-value"><span id="testA">0</span> å›</div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">ğŸ </div>
              <div class="stat-label">ãŠæ‰‹ä¼ã„</div>
              <div class="stat-value"><span id="taskA">0</span> å›</div>
            </div>
          </div>
          <button class="record-btn" onclick="toggleForm('A')">ğŸ“ ä»Šæ—¥ã®è¨˜éŒ²ã‚’ã¤ã‘ã‚‹</button>
        </div>

        <form class="form" id="formA" onsubmit="submitForm(event, 'A')">
          <div class="form-group">
            <label class="form-label">ğŸ“… æ—¥ä»˜</label>
            <input type="date" name="date" required class="form-input today-date">
          </div>
          
          <div class="form-group">
            <label class="form-label">ğŸ›ï¸ å°±å¯æ™‚é–“</label>
            <input type="time" name="bedtime" class="form-input now-time">
          </div>
          
          <div class="test-section">
            <div class="test-section-title">
              ğŸ“š ãƒ†ã‚¹ãƒˆè¨˜éŒ²
            </div>
            <div id="testsContainerA">
              <div class="test-container" data-test-index="0">
                <div class="test-header">
                  <span class="test-title">ãƒ†ã‚¹ãƒˆ 1</span>
                  <button type="button" class="remove-test-btn" onclick="removeTest(this)" style="display: none;">å‰Šé™¤</button>
                </div>
                <div class="test-row">
                  <div class="form-group">
                    <label class="form-label">ç‚¹æ•°</label>
                    <input type="number" name="test_score" min="0" max="100" class="form-input test-score" placeholder="ç‚¹æ•°ã‚’å…¥åŠ›">
                  </div>
                  <div class="form-group">
                    <label class="form-label">ç§‘ç›®</label>
                    <select name="test_subject" class="form-input test-subject" onchange="handleTestSubjectOther(this, 'A', 0)">
                      <option value="">--é¸æŠ--</option>
                      <option value="å›½èª">å›½èª</option>
                      <option value="ç®—æ•°">ç®—æ•°</option>
                      <option value="ç†ç§‘">ç†ç§‘</option>
                      <option value="ç¤¾ä¼š">ç¤¾ä¼š</option>
                      <option value="ãã®ä»–">ãã®ä»–</option>
                    </select>
                    <input type="text" name="test_subject_other" class="form-input test-subject-other" id="testSubjectOtherA0" placeholder="ç§‘ç›®ã‚’å…¥åŠ›" style="display:none;">
                  </div>
                </div>
              </div>
            </div>
            <button type="button" class="add-test-btn" onclick="addTest('A')">â• ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ </button>
          </div>

          <div class="form-group">
            <label class="form-label">ğŸ  ãŠæ‰‹ä¼ã„å†…å®¹</label>
            <select name="task" class="form-input" onchange="handleTaskOther(this, 'A')">
              <option value="">--é¸æŠ--</option>
              <option value="é´ãªã‚‰ã¹">é´ãªã‚‰ã¹</option>
              <option value="ç®¸ä¸¦ã¹">ç®¸ä¸¦ã¹</option>
              <option value="æƒé™¤">æƒé™¤</option>
              <option value="ãã®ä»–">ãã®ä»–</option>
            </select>
            <input type="text" name="taskOther" id="taskOtherA" class="form-input" placeholder="ãŠæ‰‹ä¼ã„å†…å®¹ã‚’å…¥åŠ›" style="display:none;">
          </div>
          
          <div class="checkbox-section">
            <div class="checkbox-row">
              <label><input type="checkbox" name="early"> ğŸ˜´ æ—©å¯ã‚’ã—ãŸ (+10å††)</label>
            </div>
            <div class="checkbox-row">
              <label><input type="checkbox" name="late"> ğŸŒ™ é…å¯ã‚’ã—ãŸ (-10å††)</label>
            </div>
          </div>

          <div class="submit-section">
            <button type="submit" class="submit-btn">âœ¨ è¨˜éŒ²ã‚’é€ä¿¡</button>
          </div>
        </form>
      </div>

      <!-- H ã•ã‚“ã®ã‚«ãƒ¼ãƒ‰ -->
      <div class="child-card child-h">
        <div class="child-header">
          <h2>ğŸ‘§ H ã•ã‚“</h2>
          <div class="total-amount">Â¥<span id="totalH">300</span></div>
          <div>ä»Šæœˆã®ãŠå°é£ã„</div>
        </div>
        <div class="child-content">
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-icon">ğŸ˜´</div>
              <div class="stat-label">æ—©å¯</div>
              <div class="stat-value"><span id="earlyH">0</span> å›</div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">ğŸŒ™</div>
              <div class="stat-label">é…å¯</div>
              <div class="stat-value"><span id="lateH">0</span> å›</div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">ğŸ’¯</div>
              <div class="stat-label">ãƒ†ã‚¹ãƒˆ100ç‚¹</div>
              <div class="stat-value"><span id="testH">0</span> å›</div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">ğŸ </div>
              <div class="stat-label">ãŠæ‰‹ä¼ã„</div>
              <div class="stat-value"><span id="taskH">0</span> å›</div>
            </div>
          </div>
          <button class="record-btn" onclick="toggleForm('H')">ğŸ“ ä»Šæ—¥ã®è¨˜éŒ²ã‚’ã¤ã‘ã‚‹</button>
        </div>

        <form class="form" id="formH" onsubmit="submitForm(event, 'H')">
          <div class="form-group">
            <label class="form-label">ğŸ“… æ—¥ä»˜</label>
            <input type="date" name="date" required class="form-input today-date">
          </div>
          
          <div class="form-group">
            <label class="form-label">ğŸ›ï¸ å°±å¯æ™‚é–“</label>
            <input type="time" name="bedtime" class="form-input now-time">
          </div>
          
          <div class="test-section">
            <div class="test-section-title">
              ğŸ“š ãƒ†ã‚¹ãƒˆè¨˜éŒ²
            </div>
            <div id="testsContainerH">
              <div class="test-container" data-test-index="0">
                <div class="test-header">
                  <span class="test-title">ãƒ†ã‚¹ãƒˆ 1</span>
                  <button type="button" class="remove-test-btn" onclick="removeTest(this)" style="display: none;">å‰Šé™¤</button>
                </div>
                <div class="test-row">
                  <div class="form-group">
                    <label class="form-label">ç‚¹æ•°</label>
                    <input type="number" name="test_score" min="0" max="100" class="form-input test-score" placeholder="ç‚¹æ•°ã‚’å…¥åŠ›">
                  </div>
                  <div class="form-group">
                    <label class="form-label">ç§‘ç›®</label>
                    <select name="test_subject" class="form-input test-subject" onchange="handleTestSubjectOther(this, 'H', 0)">
                      <option value="">--é¸æŠ--</option>
                      <option value="å›½èª">å›½èª</option>
                      <option value="ç®—æ•°">ç®—æ•°</option>
                      <option value="ç†ç§‘">ç†ç§‘</option>
                      <option value="ç¤¾ä¼š">ç¤¾ä¼š</option>
                      <option value="ãã®ä»–">ãã®ä»–</option>
                    </select>
                    <input type="text" name="test_subject_other" class="form-input test-subject-other" id="testSubjectOtherH0" placeholder="ç§‘ç›®ã‚’å…¥åŠ›" style="display:none;">
                  </div>
                </div>
              </div>
            </div>
            <button type="button" class="add-test-btn" onclick="addTest('H')">â• ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ </button>
          </div>

          <div class="form-group">
            <label class="form-label">ğŸ  ãŠæ‰‹ä¼ã„å†…å®¹</label>
            <select name="task" class="form-input" onchange="handleTaskOther(this, 'H')">
              <option value="">--é¸æŠ--</option>
              <option value="é´ãªã‚‰ã¹">é´ãªã‚‰ã¹</option>
              <option value="ç®¸ä¸¦ã¹">ç®¸ä¸¦ã¹</option>
              <option value="æƒé™¤">æƒé™¤</option>
              <option value="ãã®ä»–">ãã®ä»–</option>
            </select>
            <input type="text" name="taskOther" id="taskOtherH" class="form-input" placeholder="ãŠæ‰‹ä¼ã„å†…å®¹ã‚’å…¥åŠ›" style="display:none;">
          </div>
          
          <div class="checkbox-section">
            <div class="checkbox-row">
              <label><input type="checkbox" name="early"> ğŸ˜´ æ—©å¯ã‚’ã—ãŸ (+10å††)</label>
            </div>
            <div class="checkbox-row">
              <label><input type="checkbox" name="late"> ğŸŒ™ é…å¯ã‚’ã—ãŸ (-10å††)</label>
            </div>
          </div>

          <div class="submit-section">
            <button type="submit" class="submit-btn">âœ¨ è¨˜éŒ²ã‚’é€ä¿¡</button>
          </div>
        </form>
      </div>
    </div>

    <div class="message" id="message"></div>

    <div class="actions-section">
      <div class="actions-grid">
        <button class="action-btn" onclick="toggleHistory()">ğŸ“Š å±¥æ­´ã‚’è¦‹ã‚‹</button>
        <button class="action-btn" onclick="showLastMonth()">ğŸ“ˆ å…ˆæœˆã®çµæœ</button>
      </div>
    </div>

    <div id="history" class="history-section" style="display:none;"></div>
    <div id="lastMonth" class="last-month-section" style="display:none;"></div>

    <!-- ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="versionModal" class="version-modal">
      <div class="version-content">
        <button class="version-close" onclick="closeVersionInfo()">Ã—</button>
        
        <div class="version-header">
          <h2 class="version-title">ğŸ† ãŠå°é£ã„ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h2>
          <div class="version-current">Version 2.1.0</div>
        </div>

        <div class="version-section">
          <h3>ğŸ“± æ–°æ©Ÿèƒ½ v2.1.0</h3>
          <ul>
            <li>è¤‡æ•°ãƒ†ã‚¹ãƒˆå¯¾å¿œ: 1æ—¥ã«è¤‡æ•°ã®ãƒ†ã‚¹ãƒˆã‚’è¨˜éŒ²å¯èƒ½</li>
            <li>å‹•çš„ãƒ†ã‚¹ãƒˆè¿½åŠ : ã€Œãƒ†ã‚¹ãƒˆã‚’è¿½åŠ ã€ãƒœã‚¿ãƒ³ã§ç„¡åˆ¶é™è¿½åŠ </li>
            <li>ãƒªãƒƒãƒUI: ãƒ¢ãƒ€ãƒ³ãªã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ã€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœ</li>
            <li>ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³: ã‚¹ãƒãƒ›ãƒ»ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒ»PCå¯¾å¿œ</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>ğŸ¯ åŸºæœ¬æ©Ÿèƒ½</h3>
          <ul>
            <li>å­ä¾›åˆ¥ç®¡ç†: Aã•ã‚“ï¼ˆåŸºæœ¬600å††ï¼‰ã€Hã•ã‚“ï¼ˆåŸºæœ¬300å††ï¼‰</li>
            <li>ãƒã‚¤ãƒ³ãƒˆåˆ¶: ãƒ†ã‚¹ãƒˆ100ç‚¹(+100å††)ã€ãŠæ‰‹ä¼ã„(+10å††)</li>
            <li>ç”Ÿæ´»ç¿’æ…£: æ—©å¯(+10å††)ã€é…å¯(-10å††)</li>
            <li>å±¥æ­´ç®¡ç†: ç›´è¿‘10æ—¥é–“ã®è¨˜éŒ²è¡¨ç¤º</li>
            <li>æœˆæ¬¡é›†è¨ˆ: å…ˆæœˆã®çµæœè¡¨ç¤º</li>
          </ul>
        </div>

        <div class="version-section">
          <h3>ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ</h3>
          <ul>
            <li>ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: HTML/CSS/JavaScript</li>
            <li>ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: Google Apps Script</li>
            <li>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹: Google Spreadsheet</li>
            <li>è¤‡æ•°ãƒ†ã‚¹ãƒˆ: JSONå½¢å¼ã§ãƒ‡ãƒ¼ã‚¿ä¿å­˜</li>
          </ul>
        </div>

        <div class="version-footer">
          <p>æœ€çµ‚æ›´æ–°: 2025å¹´6æœˆ2æ—¥</p>
          <p>ğŸ‰ è¤‡æ•°ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ãŒå®Œå…¨å‹•ä½œä¸­ï¼</p>
        </div>
      </div>
    </div>

    <div class="spreadsheet-link">
      <a href="https://docs.google.com/spreadsheets/d/1TYzfK0qGEYS-_njaXugkHO8knr1dJTOqPU_4qrDva_s/edit?usp=sharing" target="_blank" rel="noopener noreferrer">
        ğŸ“Š å…ƒãƒ‡ãƒ¼ã‚¿ï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆï¼‰ã‚’è¦‹ã‚‹
      </a>
    </div>
  </div>

  <script>
    const endpoint = "https://script.google.com/macros/s/AKfycbyjBZGHrGGLgTvnS1GYbr_SYd-1F0QISJFMiv5JgeMexQSQDrlHnoQS3-llIPOaE2EY/exec";
    let testCounters = { A: 1, H: 1 };

    function handleTaskOther(select, child) {
      const input = document.getElementById(`taskOther${child}`);
      input.style.display = select.value === "ãã®ä»–" ? "block" : "none";
    }

    function handleTestSubjectOther(select, child, testIndex) {
      const input = document.getElementById(`testSubjectOther${child}${testIndex}`);
      input.style.display = select.value === "ãã®ä»–" ? "block" : "none";
    }

    function addTest(child) {
      const container = document.getElementById(`testsContainer${child}`);
      const testIndex = testCounters[child];
      testCounters[child]++;

      const testDiv = document.createElement('div');
      testDiv.className = 'test-container';
      testDiv.setAttribute('data-test-index', testIndex);
      testDiv.style.opacity = '0';
      testDiv.style.transform = 'translateY(-20px)';
      
      testDiv.innerHTML = `
        <div class="test-header">
          <span class="test-title">ãƒ†ã‚¹ãƒˆ ${testIndex + 1}</span>
          <button type="button" class="remove-test-btn" onclick="removeTest(this)">å‰Šé™¤</button>
        </div>
        <div class="test-row">
          <div class="form-group">
            <label class="form-label">ç‚¹æ•°</label>
            <input type="number" name="test_score" min="0" max="100" class="form-input test-score" placeholder="ç‚¹æ•°ã‚’å…¥åŠ›">
          </div>
          <div class="form-group">
            <label class="form-label">ç§‘ç›®</label>
            <select name="test_subject" class="form-input test-subject" onchange="handleTestSubjectOther(this, '${child}', ${testIndex})">
              <option value="">--é¸æŠ--</option>
              <option value="å›½èª">å›½èª</option>
              <option value="ç®—æ•°">ç®—æ•°</option>
              <option value="ç†ç§‘">ç†ç§‘</option>
              <option value="ç¤¾ä¼š">ç¤¾ä¼š</option>
              <option value="ãã®ä»–">ãã®ä»–</option>
            </select>
            <input type="text" name="test_subject_other" class="form-input test-subject-other" id="testSubjectOther${child}${testIndex}" placeholder="ç§‘ç›®ã‚’å…¥åŠ›" style="display:none;">
          </div>
        </div>
      `;
      
      container.appendChild(testDiv);
      
      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœ
      setTimeout(() => {
        testDiv.style.transition = 'all 0.3s ease';
        testDiv.style.opacity = '1';
        testDiv.style.transform = 'translateY(0)';
      }, 10);
      
      updateRemoveButtons(child);
    }

    function removeTest(button) {
      const testContainer = button.closest('.test-container');
      const form = testContainer.closest('form');
      const child = form.id.slice(-1);
      
      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœ
      testContainer.style.transition = 'all 0.3s ease';
      testContainer.style.opacity = '0';
      testContainer.style.transform = 'translateX(-100%)';
      
      setTimeout(() => {
        testContainer.remove();
        updateRemoveButtons(child);
        updateTestTitles(child);
      }, 300);
    }

    function updateRemoveButtons(child) {
      const container = document.getElementById(`testsContainer${child}`);
      const testContainers = container.querySelectorAll('.test-container');
      
      testContainers.forEach((container, index) => {
        const removeBtn = container.querySelector('.remove-test-btn');
        removeBtn.style.display = testContainers.length > 1 ? 'block' : 'none';
      });
    }

    function updateTestTitles(child) {
      const container = document.getElementById(`testsContainer${child}`);
      const testContainers = container.querySelectorAll('.test-container');
      
      testContainers.forEach((container, index) => {
        const title = container.querySelector('.test-title');
        title.textContent = `ãƒ†ã‚¹ãƒˆ ${index + 1}`;
      });
    }

    function toggleForm(child) {
      const form = document.getElementById("form" + child);
      if (form.style.display === 'block') {
        form.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
          form.style.display = 'none';
        }, 300);
      } else {
        form.style.display = 'block';
        form.style.animation = 'slideIn 0.3s ease';
      }
    }

    function submitForm(event, child) {
      event.preventDefault();
      const form = event.target;
      const submitBtn = form.querySelector('.submit-btn');
      const originalText = submitBtn.textContent;
      
      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹
      submitBtn.innerHTML = '<div class="loading"></div> é€ä¿¡ä¸­...';
      submitBtn.disabled = true;
      
      const formData = new FormData();
      formData.append("child", child);
      formData.append("date", form.date.value);
      formData.append("bedtime", form.bedtime.value);
      formData.append("early", form.early.checked);
      formData.append("late", form.late.checked);
      
      const taskVal = form.task.value === "ãã®ä»–" ? form.taskOther.value : form.task.value;
      formData.append("task", taskVal);

      // ãƒ†ã‚¹ãƒˆæƒ…å ±ã‚’åé›†ï¼ˆãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ ï¼‰
      const testContainers = form.querySelectorAll('.test-container');
      const tests = [];
      
      console.log(`${child}ã•ã‚“: ${testContainers.length}å€‹ã®ãƒ†ã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒŠã‚’ç™ºè¦‹`);
      
      testContainers.forEach((container, index) => {
        const scoreInput = container.querySelector('.test-score');
        const subjectSelect = container.querySelector('.test-subject');
        const subjectOtherInput = container.querySelector('.test-subject-other');
        
        const score = scoreInput ? scoreInput.value : '';
        const subject = subjectSelect ? subjectSelect.value : '';
        const subjectOther = subjectOtherInput ? subjectOtherInput.value : '';
        
        console.log(`ãƒ†ã‚¹ãƒˆ${index + 1}: ç‚¹æ•°=${score}, ç§‘ç›®=${subject}, ãã®ä»–=${subjectOther}`);
        
        if (score && score.trim() !== '') { // ç‚¹æ•°ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿è¨˜éŒ²
          const finalSubject = subject === "ãã®ä»–" ? subjectOther : subject;
          const testData = {
            score: parseInt(score),
            subject: finalSubject || 'æœªå…¥åŠ›'
          };
          tests.push(testData);
          console.log(`ãƒ†ã‚¹ãƒˆè¿½åŠ :`, testData);
        }
      });

      console.log(`${child}ã•ã‚“: æœ€çµ‚çš„ãªãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿:`, tests);

      // æ¡ˆ1ï¼šæ—¢å­˜åˆ—ä¿æŒï¼‹ãƒ†ã‚¹ãƒˆè©³ç´°åˆ—è¿½åŠ 
      // æ—¢å­˜åˆ—ç”¨ï¼ˆæœ€åˆã®ãƒ†ã‚¹ãƒˆï¼‰
      if (tests.length > 0) {
        formData.append("test", tests[0].score);
        formData.append("subject", tests[0].subject);
        console.log(`æ—¢å­˜åˆ—ç”¨ãƒ‡ãƒ¼ã‚¿: ç‚¹æ•°=${tests[0].score}, ç§‘ç›®=${tests[0].subject}`);
      } else {
        formData.append("test", "");
        formData.append("subject", "");
        console.log('æ—¢å­˜åˆ—ç”¨ãƒ‡ãƒ¼ã‚¿: ãƒ†ã‚¹ãƒˆãªã—');
      }
      
      // æ–°ã—ã„ãƒ†ã‚¹ãƒˆè©³ç´°åˆ—
      const testsJSON = JSON.stringify(tests);
      formData.append("tests", testsJSON);
      console.log(`ãƒ†ã‚¹ãƒˆè©³ç´°JSON:`, testsJSON);

      fetch(endpoint, {
        method: "POST",
        body: formData
      })
      .then(res => res.text())
      .then(msg => {
        console.log('ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', msg);
        const messageDiv = document.getElementById("message");
        messageDiv.textContent = "âœ… è¨˜éŒ²ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼š" + msg;
        messageDiv.style.display = "block";
        
        form.reset();
        form.style.display = 'none';
        resetTestContainers(child);
        
        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’3ç§’å¾Œã«éè¡¨ç¤º
        setTimeout(() => {
          messageDiv.style.display = "none";
        }, 3000);
        
        setTimeout(() => updateCounts(), 1000);
      })
      .catch(err => {
        console.error('é€ä¿¡ã‚¨ãƒ©ãƒ¼:', err);
        alert("âŒ é€ä¿¡ã‚¨ãƒ©ãƒ¼ï¼š" + err);
      })
      .finally(() => {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      });
    }

    function resetTestContainers(child) {
      const container = document.getElementById(`testsContainer${child}`);
      const testContainers = container.querySelectorAll('.test-container');
      
      for (let i = testContainers.length - 1; i > 0; i--) {
        testContainers[i].remove();
      }
      
      const firstContainer = container.querySelector('.test-container');
      if (firstContainer) {
        const removeBtn = firstContainer.querySelector('.remove-test-btn');
        removeBtn.style.display = 'none';
        const subjectOtherInput = firstContainer.querySelector('.test-subject-other');
        if (subjectOtherInput) {
          subjectOtherInput.style.display = 'none';
        }
      }
      
      testCounters[child] = 1;
    }

    async function updateCounts() {
      const names = ["A", "H"];
      const now = new Date();
      const thisMonth = now.getMonth();
      const thisYear = now.getFullYear();

      for (const name of names) {
        const url = `${endpoint}?history=true&child=${name}`;
        try {
          const res = await fetch(url);
          const data = await res.json();

          const filtered = data.filter(row => {
            const d = new Date(row["æ—¥ä»˜"]);
            return d.getFullYear() === thisYear && d.getMonth() === thisMonth;
          });

          const early = filtered.filter(row => row["æ—©å¯"] === 1 || row["æ—©å¯"] === "1").length;
          const late = filtered.filter(row => row["é…å¯"] === 1 || row["é…å¯"] === "1").length;
          
          let test100Count = 0;
          filtered.forEach(row => {
            // æ¡ˆ1ï¼šãƒ†ã‚¹ãƒˆè©³ç´°åˆ—ã‚’å„ªå…ˆã€ãªã‘ã‚Œã°æ—¢å­˜åˆ—ã‚‚ç¢ºèª
            if (row["ãƒ†ã‚¹ãƒˆè©³ç´°"]) {
              try {
                const tests = JSON.parse(row["ãƒ†ã‚¹ãƒˆè©³ç´°"]);
                if (Array.isArray(tests)) {
                  test100Count += tests.filter(test => test.score === 100).length;
                }
              } catch (e) {}
            } else if (Number(row["ãƒ†ã‚¹ãƒˆç‚¹æ•°"]) === 100) {
              // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®å¾Œæ–¹äº’æ›æ€§
              test100Count++;
            }
          });
          
          const task = filtered.filter(row => row["ãŠæ‰‹ä¼ã„å†…å®¹"] && row["ãŠæ‰‹ä¼ã„å†…å®¹"].toString().trim() !== "").length;

          const total = filtered.reduce((sum, row) => {
            let delta = 0;
            
            // æ¡ˆ1ï¼šãƒ†ã‚¹ãƒˆè©³ç´°åˆ—ã‚’å„ªå…ˆã€ãªã‘ã‚Œã°æ—¢å­˜åˆ—ã‚‚ç¢ºèª
            if (row["ãƒ†ã‚¹ãƒˆè©³ç´°"]) {
              try {
                const tests = JSON.parse(row["ãƒ†ã‚¹ãƒˆè©³ç´°"]);
                if (Array.isArray(tests)) {
                  delta += tests.filter(test => test.score === 100).length * 100;
                }
              } catch (e) {}
            } else if (Number(row["ãƒ†ã‚¹ãƒˆç‚¹æ•°"]) === 100) {
              // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®å¾Œæ–¹äº’æ›æ€§
              delta += 100;
            }
            
            if (row["ãŠæ‰‹ä¼ã„å†…å®¹"] && row["ãŠæ‰‹ä¼ã„å†…å®¹"].toString().trim() !== "") delta += 10;
            if (row["æ—©å¯"] === 1 || row["æ—©å¯"] === "1") delta += 10;
            if (row["é…å¯"] === 1 || row["é…å¯"] === "1") delta -= 10;
            return sum + delta;
          }, name === "A" ? 600 : 300);

          // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœä»˜ãã§æ•°å€¤æ›´æ–°
          animateValue(`early${name}`, parseInt(document.getElementById(`early${name}`).textContent), early);
          animateValue(`late${name}`, parseInt(document.getElementById(`late${name}`).textContent), late);
          animateValue(`test${name}`, parseInt(document.getElementById(`test${name}`).textContent), test100Count);
          animateValue(`task${name}`, parseInt(document.getElementById(`task${name}`).textContent), task);
          animateValue(`total${name}`, parseInt(document.getElementById(`total${name}`).textContent), total);

        } catch (err) {
          console.error(`ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°å¤±æ•—(${name})`, err);
        }
      }
    }

    function animateValue(elementId, start, end) {
      const element = document.getElementById(elementId);
      const duration = 1000;
      const startTime = performance.now();

      function update(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const current = Math.round(start + (end - start) * progress);
        
        element.textContent = current;
        
        if (progress < 1) {
          requestAnimationFrame(update);
        }
      }
      
      requestAnimationFrame(update);
    }

    window.addEventListener("DOMContentLoaded", () => {
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, '0');
      const dd = String(now.getDate()).padStart(2, '0');
      const dateStr = `${yyyy}-${mm}-${dd}`;
      const hh = String(now.getHours()).padStart(2, '0');
      const mi = String(now.getMinutes()).padStart(2, '0');
      const timeStr = `${hh}:${mi}`;

      document.querySelectorAll(".today-date").forEach(el => el.value = dateStr);
      document.querySelectorAll(".now-time").forEach(el => el.value = timeStr);

      updateCounts();
    });

    async function toggleHistory() {
      const historyDiv = document.getElementById("history");
      historyDiv.style.display = historyDiv.style.display === "none" ? "block" : "none";
      if (historyDiv.innerHTML) return;

      historyDiv.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading"></div> ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';

      const names = ["A", "H"];
      let content = '';
      
      for (const name of names) {
        const url = `${endpoint}?history=true&child=${name}`;
        try {
          const res = await fetch(url);
          const data = await res.json();

          const recent = data
            .map(row => ({ ...row, parsed: new Date(row["æ—¥ä»˜"]) }))
            .sort((a, b) => a.parsed - b.parsed)
            .slice(-10);

          content += `
            <table>
              <thead>
                <tr>
                  <th colspan="8">ğŸ“Š ${name} ã•ã‚“ã®ç›´è¿‘10æ—¥é–“ã®å±¥æ­´</th>
                </tr>
                <tr>
                  <th>ğŸ“… æ—¥ä»˜</th><th>ğŸ›ï¸ å°±å¯</th><th>ğŸ“š ãƒ†ã‚¹ãƒˆè©³ç´°</th><th>ğŸ  æ‰‹ä¼ã„</th><th>ğŸ˜´ æ—©å¯</th><th>ğŸŒ™ é…å¯</th><th>ğŸ’° å¢—æ¸›</th><th>ğŸ’µ ç´¯ç©</th>
                </tr>
              </thead>
              <tbody>
          `;

          for (const row of recent) {
            const d = row.parsed;
            const weekday = "æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ"[d.getDay()];
            const dateStr = `${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getDate().toString().padStart(2, '0')}(${weekday})`;

            let bedtime = "";
            const raw = row["å°±å¯æ™‚é–“"];
            if (typeof raw === "string" && raw.includes("T")) {
              const t = new Date(raw);
              if (!isNaN(t)) bedtime = `${String(t.getHours()).padStart(2, '0')}:${String(t.getMinutes()).padStart(2, '0')}`;
            } else if (typeof raw === "string" && raw.includes(":")) {
              const [h, m] = raw.split(":");
              bedtime = `${h.padStart(2, '0')}:${m.padStart(2, '0')}`;
            }

            let testDetails = "";
            // æ¡ˆ1ï¼šãƒ†ã‚¹ãƒˆè©³ç´°åˆ—ã‚’å„ªå…ˆã€ãªã‘ã‚Œã°æ—¢å­˜åˆ—ã‚‚ç¢ºèª
            if (row["ãƒ†ã‚¹ãƒˆè©³ç´°"]) {
              try {
                const tests = JSON.parse(row["ãƒ†ã‚¹ãƒˆè©³ç´°"]);
                if (Array.isArray(tests)) {
                  testDetails = tests.map(test => `${test.subject || '?'}:${test.score}ç‚¹`).join('<br>');
                }
              } catch (e) {
                testDetails = row["ãƒ†ã‚¹ãƒˆè©³ç´°"];
              }
            } else if (row["ç§‘ç›®"] || row["ãƒ†ã‚¹ãƒˆç‚¹æ•°"]) {
              // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®å¾Œæ–¹äº’æ›æ€§
              testDetails = `${row["ç§‘ç›®"] || '?'}:${row["ãƒ†ã‚¹ãƒˆç‚¹æ•°"] || '?'}ç‚¹`;
            }

            content += `
              <tr>
                <td>${dateStr}</td>
                <td>${bedtime}</td>
                <td>${testDetails}</td>
                <td>${row["ãŠæ‰‹ä¼ã„å†…å®¹"] || ""}</td>
                <td>${row["æ—©å¯"] == "1" ? "âœ…" : ""}</td>
                <td>${row["é…å¯"] == "1" ? "âŒ" : ""}</td>
                <td>${row["å¢—æ¸›"] || ""}</td>
                <td>${row["ç´¯ç©é‡‘é¡"] || ""}</td>
              </tr>
            `;
          }
          
          content += '</tbody></table>';
        } catch (err) {
          content += `<p>âŒ ${name} ã•ã‚“ã®å±¥æ­´å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>`;
        }
      }
      
      historyDiv.innerHTML = content;
    }

    async function showLastMonth() {
      const lastMonthDiv = document.getElementById("lastMonth");
      lastMonthDiv.style.display = lastMonthDiv.style.display === "none" ? "block" : "none";
      if (lastMonthDiv.innerHTML) return;

      lastMonthDiv.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loading"></div> ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';

      const names = ["A", "H"];
      const now = new Date();
      let year = now.getFullYear();
      let month = now.getMonth() - 1;
      if (month < 0) {
        month = 11;
        year--;
      }

      let html = '<h3 style="text-align: center; margin-bottom: 20px; color: #333;">ğŸ“ˆ å…ˆæœˆã®çµæœ</h3>';
      
      for (const name of names) {
        const url = `${endpoint}?history=true&child=${name}`;
        try {
          const res = await fetch(url);
          const data = await res.json();

          const filtered = data.filter(row => {
            const d = new Date(row["æ—¥ä»˜"]);
            return d.getFullYear() === year && d.getMonth() === month;
          });

          const early = filtered.filter(row => row["æ—©å¯"] === 1 || row["æ—©å¯"] === "1").length;
          const late = filtered.filter(row => row["é…å¯"] === 1 || row["é…å¯"] === "1").length;
          
          let test100Count = 0;
          const testSubjects = {};
          
          filtered.forEach(row => {
            // æ¡ˆ1ï¼šãƒ†ã‚¹ãƒˆè©³ç´°åˆ—ã‚’å„ªå…ˆã€ãªã‘ã‚Œã°æ—¢å­˜åˆ—ã‚‚ç¢ºèª
            if (row["ãƒ†ã‚¹ãƒˆè©³ç´°"]) {
              try {
                const tests = JSON.parse(row["ãƒ†ã‚¹ãƒˆè©³ç´°"]);
                if (Array.isArray(tests)) {
                  tests.forEach(test => {
                    if (test.score === 100) {
                      test100Count++;
                      const subj = test.subject || "ï¼ˆæœªå…¥åŠ›ï¼‰";
                      testSubjects[subj] = (testSubjects[subj] || 0) + 1;
                    }
                  });
                }
              } catch (e) {}
            } else if (Number(row["ãƒ†ã‚¹ãƒˆç‚¹æ•°"]) === 100) {
              // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®å¾Œæ–¹äº’æ›æ€§
              test100Count++;
              const subj = row["ç§‘ç›®"] || "ï¼ˆæœªå…¥åŠ›ï¼‰";
              testSubjects[subj] = (testSubjects[subj] || 0) + 1;
            }
          });

          const taskRows = filtered.filter(row => row["ãŠæ‰‹ä¼ã„å†…å®¹"] && row["ãŠæ‰‹ä¼ã„å†…å®¹"].toString().trim() !== "");
          const task = taskRows.length;
          const taskDetails = {};
          taskRows.forEach(row => {
            const taskName = row["ãŠæ‰‹ä¼ã„å†…å®¹"] || "ï¼ˆæœªå…¥åŠ›ï¼‰";
            taskDetails[taskName] = (taskDetails[taskName] || 0) + 1;
          });

          const total = filtered.reduce((sum, row) => {
            let delta = 0;
            // æ¡ˆ1ï¼šãƒ†ã‚¹ãƒˆè©³ç´°åˆ—ã‚’å„ªå…ˆã€ãªã‘ã‚Œã°æ—¢å­˜åˆ—ã‚‚ç¢ºèª
            if (row["ãƒ†ã‚¹ãƒˆè©³ç´°"]) {
              try {
                const tests = JSON.parse(row["ãƒ†ã‚¹ãƒˆè©³ç´°"]);
                if (Array.isArray(tests)) {
                  delta += tests.filter(test => test.score === 100).length * 100;
                }
              } catch (e) {}
            } else if (Number(row["ãƒ†ã‚¹ãƒˆç‚¹æ•°"]) === 100) {
              // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®å¾Œæ–¹äº’æ›æ€§
              delta += 100;
            }
            if (row["ãŠæ‰‹ä¼ã„å†…å®¹"] && row["ãŠæ‰‹ä¼ã„å†…å®¹"].toString().trim() !== "") delta += 10;
            if (row["æ—©å¯"] === 1 || row["æ—©å¯"] === "1") delta += 10;
            if (row["é…å¯"] === 1 || row["é…å¯"] === "1") delta -= 10;
            return sum + delta;
          }, name === "A" ? 600 : 300);

          let testDetailHtml = "";
          if (test100Count > 0) {
            testDetailHtml = "<ul style='margin:5px 0;padding-left:1.2em; text-align: left;'>";
            for (const subj in testSubjects) {
              testDetailHtml += `<li>${subj}: ${testSubjects[subj]} å›</li>`;
            }
            testDetailHtml += "</ul>";
          }

          let taskDetailHtml = "";
          if (task > 0) {
            taskDetailHtml = "<ul style='margin:5px 0;padding-left:1.2em; text-align: left;'>";
            for (const t in taskDetails) {
              taskDetailHtml += `<li>${t}: ${taskDetails[t]} å›</li>`;
            }
            taskDetailHtml += "</ul>";
          }

          html += `
            <table style="margin-bottom: 20px;">
              <thead>
                <tr><th colspan="2">ğŸ† ${name} ã•ã‚“ã®å…ˆæœˆã®çµæœ</th></tr>
              </thead>
              <tbody>
                <tr><td>ğŸ’° ãŠå°é£ã„</td><td><strong>Â¥${total}</strong></td></tr>
                <tr><td>ğŸ˜´ æ—©å¯</td><td>${early} å›</td></tr>
                <tr><td>ğŸŒ™ é…å¯</td><td>${late} å›</td></tr>
                <tr><td>ğŸ’¯ ãƒ†ã‚¹ãƒˆï¼ˆ100ç‚¹ï¼‰</td><td>${test100Count} å›${testDetailHtml}</td></tr>
                <tr><td>ğŸ  ãŠæ‰‹ä¼ã„å†…å®¹</td><td>${task} å›${taskDetailHtml}</td></tr>
              </tbody>
            </table>
          `;
        } catch (err) {
          html += `<p>âŒ ${name} ã•ã‚“ã®å…ˆæœˆãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>`;
        }
      }
      lastMonthDiv.innerHTML = html;
    }

    // ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã®è¡¨ç¤º/éè¡¨ç¤º
    function showVersionInfo() {
      const modal = document.getElementById("versionModal");
      modal.style.display = "flex";
      
      // ESCã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closeVersionInfo();
        }
      });
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          closeVersionInfo();
        }
      });
    }

    function closeVersionInfo() {
      const modal = document.getElementById("versionModal");
      modal.style.display = "none";
    }
  </script>
</body>
</html>

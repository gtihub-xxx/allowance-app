// お小遣い管理システム v2.2.0 - Google Apps Script
// 更新履歴:
// v2.2.0: UI改良 - 統計レイアウトを2x2グリッドに最適化
// v2.1.0: 複数テスト対応機能実装
// スプレッドシート構造：日付 | 就寝時間 | テスト点数 | 科目 | テスト詳細 | お手伝い | 早寝 | 遅寝 | 増減 | 累積金額

function doPost(e) {
  try {
    console.log('=== doPost 開始 ===');
    console.log('e.parameter の完全ダンプ:', JSON.stringify(e.parameter, null, 2));
    console.log('e.parameter のキー一覧:', Object.keys(e.parameter));
    console.log('e.parameter.tests の値:', e.parameter.tests);
    console.log('e.parameter.tests の型:', typeof e.parameter.tests);
    console.log('e.parameter.tests === undefined?', e.parameter.tests === undefined);
    console.log('e.parameter.tests === null?', e.parameter.tests === null);
    console.log('e.parameter.tests === ""?', e.parameter.tests === "");
    
    // すべてのパラメータを個別にログ出力
    for (const [key, value] of Object.entries(e.parameter)) {
      console.log(`パラメータ ${key}:`, value, `(型: ${typeof value})`);
    }
    
    // スプレッドシートを取得
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const child = e.parameter.child;
    const sheetName = child; // 'A' または 'H' (修正: 'さん'を削除)
    const sheet = spreadsheet.getSheetByName(sheetName);
    
    if (!sheet) {
      throw new Error(`シート "${sheetName}" が見つかりません`);
    }
    
    // 基本データの取得
    const date = e.parameter.date;
    const bedtime = e.parameter.bedtime || '';
    const task = e.parameter.task || '';
    const early = e.parameter.early === 'true';
    const late = e.parameter.late === 'true';
    
    console.log(`基本データ: 日付=${date}, 就寝=${bedtime}, お手伝い=${task}, 早寝=${early}, 遅寝=${late}`);
    
    // テストデータの処理
    let tests = [];
    let firstTestScore = '';
    let firstTestSubject = '';
    
    console.log('受信したtestsパラメータ:', e.parameter.tests);
    console.log('testsパラメータの型:', typeof e.parameter.tests);
    console.log('全パラメータ一覧:', Object.keys(e.parameter));
    
    // testsパラメータの存在確認を厳密に
    const testsParam = e.parameter.tests;
    console.log('testsParam:', testsParam);
    console.log('testsParam truthy?', !!testsParam);
    console.log('testsParam length:', testsParam ? testsParam.length : 'N/A');
    
    if (testsParam && testsParam !== '' && testsParam !== 'undefined' && testsParam !== 'null') {
      try {
        console.log('JSON.parse を試行中...');
        tests = JSON.parse(testsParam);
        console.log('JSON.parse 成功:', tests);
        console.log('解析されたテストデータ:', tests);
        console.log('テスト数:', tests.length);
        
        // 各テストの詳細をログ出力
        tests.forEach((test, index) => {
          console.log(`テスト${index + 1}: 点数=${test.score}, 科目=${test.subject}`);
        });
        
        // 最初のテストを既存列用に取得
        if (tests.length > 0) {
          firstTestScore = tests[0].score || '';
          firstTestSubject = tests[0].subject || '';
          console.log(`既存列用: 点数=${firstTestScore}, 科目=${firstTestSubject}`);
        }
      } catch (error) {
        console.error('テストデータのJSON解析エラー:', error);
        console.error('問題のあるJSON文字列:', testsParam);
        tests = [];
      }
    } else {
      console.log('testsパラメータが空またはundefined');
      console.log('利用可能なパラメータ:', Object.keys(e.parameter).join(', '));
      // 空の配列を設定
      tests = [];
    }
    
    // 増減の計算
    let delta = 0;
    
    // テストボーナス（100点のテスト数×100円）
    const perfectTests = tests.filter(test => test.score === 100);
    const testBonus = perfectTests.length * 100;
    delta += testBonus;
    console.log(`テストボーナス: 100点×${perfectTests.length}回 = ${testBonus}円`);
    
    // お手伝いボーナス
    if (task && task.trim() !== '') {
      delta += 10;
      console.log('お手伝いボーナス: +10円');
    }
    
    // 早寝・遅寝ボーナス/ペナルティ
    if (early) {
      delta += 10;
      console.log('早寝ボーナス: +10円');
    }
    if (late) {
      delta -= 10;
      console.log('遅寝ペナルティ: -10円');
    }
    
    console.log(`合計増減: ${delta}円`);
    
    // 累積金額の計算
    const baseAmount = child === 'A' ? 600 : 300; // 基本お小遣い
    const currentMonthTotal = calculateMonthlyTotal(sheet, date, baseAmount);
    const newTotal = currentMonthTotal + delta;
    
    console.log(`累積計算: 今月累積${currentMonthTotal} + 今回増減${delta} = 新累積${newTotal}`);
    
    // テスト詳細列のJSON文字列を準備
    const testDetailsJSON = tests.length > 0 ? JSON.stringify(tests) : '[]';
    console.log('スプレッドシートに書き込むテスト詳細:', testDetailsJSON);
    console.log('テスト詳細の文字数:', testDetailsJSON.length);
    
    // スプレッドシートに記録
    const newRow = [
      date,                           // A列：日付
      bedtime,                        // B列：就寝時間
      firstTestScore,                 // C列：テスト点数（既存列、最初のテスト）
      firstTestSubject,               // D列：科目（既存列、最初のテスト）
      testDetailsJSON,                // E列：テスト詳細（新規列、全テスト）
      task,                           // F列：お手伝い
      early ? 1 : 0,                  // G列：早寝
      late ? 1 : 0,                   // H列：遅寝
      delta,                          // I列：増減
      newTotal                        // J列：累積金額
    ];
    
    console.log('書き込み行データ:', newRow);
    console.log('E列に書き込む値:', newRow[4]);
    
    // 書き込み前の最終確認
    if (newRow[4] === '') {
      console.error('警告: E列が空です！testsパラメータが受信されていません');
      console.error('デバッグ: tests =', tests);
      console.error('デバッグ: testDetailsJSON =', testDetailsJSON);
    }
    
    sheet.appendRow(newRow);
    
    // 書き込み後の確認
    const lastRowNum = sheet.getLastRow();
    const writtenValue = sheet.getRange(lastRowNum, 5).getValue();
    console.log('書き込み後のE列の値:', writtenValue);
    
    console.log('=== スプレッドシート書き込み完了 ===');
    
    // 成功レスポンス
    const message = `${child}さんの記録を保存しました (v2.2.0)。増減: ${delta > 0 ? '+' : ''}${delta}円、累積: ${newTotal}円`;
    console.log('レスポンスメッセージ:', message);
    
    return ContentService.createTextOutput(message);
    
  } catch (error) {
    console.error('=== doPost エラー ===', error);
    console.error('エラースタックトレース:', error.stack);
    return ContentService.createTextOutput(`エラー: ${error.message}`);
  }
}

function doGet(e) {
  try {
    const child = e.parameter.child;
    const history = e.parameter.history;
    
    if (!child) {
      throw new Error('child パラメータが必要です');
    }
    
    if (history === 'true') {
      // 履歴データを取得
      const historyData = getChildHistory(child);
      return ContentService
        .createTextOutput(JSON.stringify(historyData))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    // 通常のレスポンス
    return ContentService.createTextOutput('お小遣い管理システム API');
    
  } catch (error) {
    console.error('doGet エラー:', error);
    return ContentService
      .createTextOutput(JSON.stringify({ error: error.message }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * 子供の履歴データを取得
 */
function getChildHistory(child) {
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const sheetName = child; // 修正: 'さん'を削除
    const sheet = spreadsheet.getSheetByName(sheetName);
    
    if (!sheet) {
      throw new Error(`シート "${sheetName}" が見つかりません`);
    }
    
    // データ範囲を取得（ヘッダー行を除く）
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      return []; // データがない場合
    }
    
    const dataRange = sheet.getRange(2, 1, lastRow - 1, 10); // A2:J最終行
    const values = dataRange.getValues();
    
    // データを JSON 形式に変換
    const headers = ['日付', '就寝時間', 'テスト点数', '科目', 'テスト詳細', 'お手伝い内容', '早寝', '遅寝', '増減', '累積金額'];
    const historyData = values.map(row => {
      const record = {};
      headers.forEach((header, index) => {
        let value = row[index];
        
        // 日付の処理
        if (header === '日付' && value instanceof Date) {
          value = Utilities.formatDate(value, Session.getScriptTimeZone(), 'yyyy-MM-dd');
        }
        
        // 就寝時間の処理
        if (header === '就寝時間' && value instanceof Date) {
          value = Utilities.formatDate(value, Session.getScriptTimeZone(), 'HH:mm');
        }
        
        record[header] = value;
      });
      return record;
    });
    
    console.log(`${child}さんの履歴データを取得: ${historyData.length}件`);
    return historyData;
    
  } catch (error) {
    console.error('履歴取得エラー:', error);
    throw error;
  }
}

/**
 * 今月の累積金額を計算
 */
function calculateMonthlyTotal(sheet, currentDate, baseAmount) {
  try {
    const targetDate = new Date(currentDate);
    const targetYear = targetDate.getFullYear();
    const targetMonth = targetDate.getMonth();
    
    // データ範囲を取得
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      return baseAmount; // データがない場合は基本金額
    }
    
    const dataRange = sheet.getRange(2, 1, lastRow - 1, 10); // A2:J最終行
    const values = dataRange.getValues();
    
    let monthlyDelta = 0;
    
    // 同月のデータのみフィルタリングして増減を合計
    values.forEach(row => {
      const rowDate = new Date(row[0]); // A列：日付
      
      if (rowDate.getFullYear() === targetYear && rowDate.getMonth() === targetMonth) {
        const delta = row[8] || 0; // I列：増減
        if (typeof delta === 'number') {
          monthlyDelta += delta;
        }
      }
    });
    
    const total = baseAmount + monthlyDelta;
    console.log(`月間累積計算: 基本${baseAmount} + 増減${monthlyDelta} = ${total}`);
    
    return total;
    
  } catch (error) {
    console.error('月間累積計算エラー:', error);
    return baseAmount; // エラー時は基本金額を返す
  }
}

/**
 * テスト用関数：手動でデータを作成
 */
function createTestData() {
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    
    // Aシートの作成/取得 (修正: 'さん'を削除)
    let sheetA = spreadsheet.getSheetByName('A');
    if (!sheetA) {
      sheetA = spreadsheet.insertSheet('A');
    }
    
    // Hシートの作成/取得 (修正: 'さん'を削除)
    let sheetH = spreadsheet.getSheetByName('H');
    if (!sheetH) {
      sheetH = spreadsheet.insertSheet('H');
    }
    
    // ヘッダー行の設定
    const headers = ['日付', '就寝時間', 'テスト点数', '科目', 'テスト詳細', 'お手伝い', '早寝', '遅寝', '増減', '累積金額'];
    
    sheetA.getRange(1, 1, 1, headers.length).setValues([headers]);
    sheetH.getRange(1, 1, 1, headers.length).setValues([headers]);
    
    console.log('テスト用シートとヘッダーを作成しました (v2.2.0)');
    
  } catch (error) {
    console.error('テストデータ作成エラー:', error);
  }
}

/**
 * 月初めにリセット用関数（必要に応じて手動実行）
 */
function resetMonthlyData() {
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const sheets = ['A', 'H']; // 修正: 'さん'を削除
    
    const confirm = Browser.msgBox(
      '月次リセット',
      '新しい月のデータをリセットしますか？\n（既存データは保持されます）',
      Browser.Buttons.YES_NO
    );
    
    if (confirm === 'yes') {
      sheets.forEach(sheetName => {
        const sheet = spreadsheet.getSheetByName(sheetName);
        if (sheet) {
          console.log(`${sheetName}シートの月次リセット準備完了`); // 修正
          // 必要に応じて追加処理
        }
      });
      
      Browser.msgBox('月次リセット完了 (v2.2.0)', '新しい月の準備が完了しました', Browser.Buttons.OK);
    }
    
  } catch (error) {
    console.error('月次リセットエラー:', error);
  }
}

/**
 * デバッグ用：スプレッドシートの構造を確認
 */
function debugSpreadsheetStructure() {
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const sheets = spreadsheet.getSheets();
    
    console.log('=== スプレッドシート構造デバッグ v2.2.0 ===');
    console.log(`スプレッドシート名: ${spreadsheet.getName()}`);
    console.log(`シート数: ${sheets.length}`);
    
    sheets.forEach(sheet => {
      const sheetName = sheet.getName();
      const lastRow = sheet.getLastRow();
      const lastCol = sheet.getLastColumn();
      
      console.log(`シート: ${sheetName}, 行数: ${lastRow}, 列数: ${lastCol}`);
      
      if (lastRow > 0) {
        const headers = sheet.getRange(1, 1, 1, lastCol).getValues()[0];
        console.log(`  ヘッダー: ${headers.join(', ')}`);
      }
    });
    
  } catch (error) {
    console.error('デバッグエラー:', error);
  }
}

/**
 * 段階1: シート存在確認
 */
function testSheetExists() {
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    
    // すべてのシート名を取得
    const sheets = spreadsheet.getSheets();
    const sheetNames = sheets.map(sheet => sheet.getName());
    
    Browser.msgBox('シート一覧 (v2.2.0)', `見つかったシート:\n${sheetNames.join('\n')}`, Browser.Buttons.OK);
    
    // Aシートの存在確認
    const sheetA = spreadsheet.getSheetByName('A');
    if (sheetA) {
      Browser.msgBox('成功', 'シート「A」が見つかりました！', Browser.Buttons.OK);
    } else {
      Browser.msgBox('エラー', 'シート「A」が見つかりません', Browser.Buttons.OK);
    }
    
  } catch (error) {
    Browser.msgBox('エラー', error.message, Browser.Buttons.OK);
  }
}

/**
 * 段階2: 基本書き込みテスト
 */
function testBasicWrite() {
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = spreadsheet.getSheetByName('A');
    
    if (!sheet) {
      Browser.msgBox('エラー', 'シート「A」が見つかりません', Browser.Buttons.OK);
      return;
    }
    
    // 最も基本的な書き込み
    sheet.getRange('A1').setValue('テスト書き込み');
    
    Browser.msgBox('成功 (v2.2.0)', 'A1セルに「テスト書き込み」を書きました！', Browser.Buttons.OK);
    
  } catch (error) {
    Browser.msgBox('エラー', error.message, Browser.Buttons.OK);
  }
}

/**
 * 緊急テスト：testsパラメータをシミュレート
 */
function testSimulateTests() {
  try {
    // 実際のフロントエンドから送信されるデータをシミュレート
    const mockEvent = {
      parameter: {
        child: 'A',
        date: '2025-06-02',
        bedtime: '22:19',
        task: '',
        early: 'false',
        late: 'false',
        test: '100',
        subject: '国語',
        tests: '[{"score":100,"subject":"国語"},{"score":100,"subject":"算数"}]'
      }
    };
    
    console.log('モックイベント作成:', mockEvent);
    
    // doPost関数を直接呼び出し
    const result = doPost(mockEvent);
    
    Browser.msgBox('テスト完了 (v2.2.0)', 'testsパラメータのシミュレーションが完了しました。\nスプレッドシートのE列を確認してください。', Browser.Buttons.OK);
    
  } catch (error) {
    console.error('シミュレーションエラー:', error);
    Browser.msgBox('エラー', 'エラー: ' + error.message, Browser.Buttons.OK);
  }
}

/**
 * 緊急デバッグ：最新行のテスト詳細を確認
 */
function debugLatestRow() {
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = spreadsheet.getSheetByName('A');
    
    if (!sheet) {
      Browser.msgBox('エラー', 'シート「A」が見つかりません', Browser.Buttons.OK);
      return;
    }
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      Browser.msgBox('情報', 'データがありません', Browser.Buttons.OK);
      return;
    }
    
    // 最新行のデータを取得
    const rowData = sheet.getRange(lastRow, 1, 1, 10).getValues()[0];
    
    const info = `最新行のデータ (v2.2.0):
日付: ${rowData[0]}
就寝時間: ${rowData[1]}
テスト点数: ${rowData[2]}
科目: ${rowData[3]}
テスト詳細: "${rowData[4]}"
お手伝い: ${rowData[5]}
早寝: ${rowData[6]}
遅寝: ${rowData[7]}
増減: ${rowData[8]}
累積: ${rowData[9]}

E列が空か?: ${rowData[4] === '' ? 'はい' : 'いいえ'}
E列の型: ${typeof rowData[4]}`;
    
    Browser.msgBox('最新行デバッグ', info, Browser.Buttons.OK);
    
  } catch (error) {
    Browser.msgBox('エラー', error.message, Browser.Buttons.OK);
  }
}
function debugLatestRow() {
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = spreadsheet.getSheetByName('A');
    
    if (!sheet) {
      Browser.msgBox('エラー', 'シート「A」が見つかりません', Browser.Buttons.OK);
      return;
    }
    
    const lastRow = sheet.getLastRow();
    if (lastRow <= 1) {
      Browser.msgBox('情報', 'データがありません', Browser.Buttons.OK);
      return;
    }
    
    // 最新行のデータを取得
    const rowData = sheet.getRange(lastRow, 1, 1, 10).getValues()[0];
    
    const info = `最新行のデータ:
日付: ${rowData[0]}
就寝時間: ${rowData[1]}
テスト点数: ${rowData[2]}
科目: ${rowData[3]}
テスト詳細: "${rowData[4]}"
お手伝い: ${rowData[5]}
早寝: ${rowData[6]}
遅寝: ${rowData[7]}
増減: ${rowData[8]}
累積: ${rowData[9]}

E列が空か?: ${rowData[4] === '' ? 'はい' : 'いいえ'}
E列の型: ${typeof rowData[4]}`;
    
    Browser.msgBox('最新行デバッグ', info, Browser.Buttons.OK);
    
  } catch (error) {
    Browser.msgBox('エラー', error.message, Browser.Buttons.OK);
  }
}
function testWriteColumn() {
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = spreadsheet.getSheetByName('A'); // 修正: 'Aさん'→'A'
    
    if (!sheet) {
      Browser.msgBox('「A」シートが見つかりません');
      return;
    }
    
    // テストデータ
    const testData = [{"score":100,"subject":"国語"},{"score":90,"subject":"算数"}];
    const testJSON = JSON.stringify(testData);
    
    console.log('テストJSON:', testJSON);
    
    // 新しい行を追加
    const newRow = [
      '2025-06-02',      // A列：日付
      '6:07',            // B列：就寝時間
      '100',             // C列：テスト点数
      '国語',            // D列：科目
      testJSON,          // E列：テスト詳細 ←これが問題の列
      '',                // F列：お手伝い
      0,                 // G列：早寝
      0,                 // H列：遅寝
      100,               // I列：増減
      700                // J列：累積金額
    ];
    
    sheet.appendRow(newRow);
    
    console.log('テスト行を追加しました');
    Browser.msgBox('テスト完了！スプレッドシートのE列を確認してください。');
    
  } catch (error) {
    console.error('エラー:', error);
    Browser.msgBox('エラー: ' + error.message);
  }
}

<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>お小遣い管理アプリ</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
    h1, h2 { text-align: center; color: #2c3e50; }
    .tabs { display: flex; justify-content: center; margin-bottom: 20px; }
    .tab { padding: 10px 20px; cursor: pointer; border-bottom: 2px solid transparent; }
    .tab.active { border-color: #3498db; color: #3498db; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .container { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    input, select, button { width: 100%; padding: 8px; margin: 8px 0; box-sizing: border-box; font-size: 16px; }
    button { background: #3498db; color: #fff; border: none; border-radius: 4px; }
    button:hover { background: #2980b9; }
    .result { background: #eef; padding: 15px; border-radius: 5px; margin-top: 10px; }
    label { display: block; margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>
  <h1>お小遣い管理アプリ</h1>
  <div class="tabs">
    <div class="tab active" data-tab="entry">記録入力</div>
    <div class="tab" data-tab="history">記録一覧</div>
    <div class="tab" data-tab="summary">月次集計</div>
  </div>

  <div id="entry" class="tab-content active container">
    <label>子どもを選択：</label>
    <select id="childSelect">
      <option value="A">Aちゃん</option>
      <option value="H">Hちゃん</option>
    </select>

    <label>日付:</label>
    <input type="date" id="date">
    <label>就寝時間:</label>
    <input type="time" id="bedtime">
    <label>テスト科目:</label>
    <input type="text" id="subject" placeholder="例: 国語">
    <label>テスト点数:</label>
    <input type="number" id="score" min="0" max="100">
    <button id="submitButton">送信</button>
    <div id="status" style="color:green;"></div>
  </div>

  <div id="history" class="tab-content container">
    <h2>記録一覧</h2>
    <p>記録一覧はGoogle Sheetsでご確認ください。</p>
  </div>

  <div id="summary" class="tab-content container">
    <h2>月次集計</h2>
    <label>子どもを選択：</label>
    <select id="childSummary">
      <option value="A">Aちゃん</option>
      <option value="H">Hちゃん</option>
    </select>
    <label>月を選択：</label>
    <input type="month" id="month">
    <button onclick="fetchSummary()">集計</button>
    <div id="summaryArea" class="result">集計結果がここに表示されます</div>
  </div>

  <script>
    const scriptUrl = "https://script.google.com/macros/s/AKfycbwQk5kfD1WDsZ3D0RKVgL-0KNabGXSW6qXksAFzJckRiY2kaJGPLh5vn9_3Ut57a-bkmA/exec";

    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab, .tab-content').forEach(el => el.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.getAttribute('data-tab')).classList.add('active');
      });
    });

    const today = new Date().toISOString().slice(0,10);
    document.getElementById('date').value = today;

    document.getElementById("submitButton").addEventListener("click", () => {
      const child = document.getElementById('childSelect').value;
      const date = document.getElementById('date').value;
      const bedtime = document.getElementById('bedtime').value;
      const subject = document.getElementById('subject').value;
      const score = document.getElementById('score').value;
      if (!date) return alert('日付を入力してください');

      fetch(`${scriptUrl}?child=${child}`, {
        method: 'POST',
        mode: 'cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ date, bedtime, subject, score })
      }).then(res => {
        if (res.ok || res.type === "opaque") {
          document.getElementById('status').textContent = '送信しました！';
          setTimeout(() => document.getElementById('status').textContent = '', 3000);
        } else {
          alert('送信失敗（レスポンスエラー）');
        }
      }).catch(e => {
        console.error('送信エラー:', e);
        alert('送信失敗（通信エラー）');
      });
    });

    function fetchSummary() {
      const child = document.getElementById('childSummary').value;
      const month = document.getElementById('month').value;
      if (!month) return alert('月を選択してください');
      fetch(`${scriptUrl}?child=${child}&month=${month}`)
        .then(res => res.json())
        .then(data => {
          document.getElementById('summaryArea').innerHTML = `
            <p>・早寝ボーナス（基準前就寝）: ${data.beforeBedtimeCount}回</p>
            <p>・遅寝ペナルティ（基準後就寝）: ${data.afterBedtimeCount}回</p>
            <p>・テスト100点: ${data.testPerfectCount}回</p>
            <p><strong>今月のお小遣い: ${data.totalAllowance}円</strong></p>
          `;
        }).catch(e => alert('集計取得失敗'));
    }
  </script>
</body>
</html>
